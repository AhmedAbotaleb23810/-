<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة التحكم — السوبر ماركت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#0a1a2f; --bg2:#122b4a;
      --card:#0f213a; --muted:#cbd8e3;
      --accent:#4da8da; --accent-dark:#27517d;
      --success:#27ae60; --danger:#e74c3c; --warn:#f39c12;
      --border:rgba(255,255,255,0.08);
    }
    body{
      margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(to right,var(--bg1),var(--bg2)); color:#fff;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:rgba(0,0,0,0.12); backdrop-filter:blur(4px); box-shadow:0 4px 16px rgba(0,0,0,.35);
    }
    header h1{margin:0; font-size:20px; display:flex; gap:10px; align-items:center}
    .user-controls{display:flex; gap:10px; align-items:center}
    .user-name{font-weight:600; color:var(--muted)}
    .btn{
      background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px;
      font-weight:700; cursor:pointer; transition:transform .12s ease,background .15s ease;
    }
    .btn:hover{transform:translateY(-2px); background:var(--accent-dark)}
    .btn.secondary{background:rgba(255,255,255,.06); color:var(--muted); border:1px solid var(--border)}
    .btn.danger{background:var(--danger)}
    .btn.warn{background:var(--warn); color:#222}
    main{max-width:1150px; margin:26px auto; padding:0 16px 70px; width:100%}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .search{display:flex; gap:8px; align-items:center; flex:1; min-width:220px}
    input, select{
      background:rgba(255,255,255,.05); color:#fff; border:1px solid var(--border);
      padding:10px 12px; border-radius:10px; outline:none; font-size:14px;
    }
    input::placeholder{color:#9fb3c6}
    .cards{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    @media (max-width:1000px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px;
      display:flex; flex-direction:column; gap:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{transform:translateY(-5px); box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .title{font-size:17px; font-weight:800}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .chip{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:8px; border:1px solid var(--border); font-weight:700}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .alert{
      position:fixed; left:50%; transform:translateX(-50%); top:16px; z-index:1200; display:none;
      padding:10px 16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.5);
    }
    .alert.success{background:linear-gradient(90deg,rgba(39,174,96,.95),rgba(30,132,73,.95)); color:#fff}
    .alert.error{background:linear-gradient(90deg,rgba(231,76,60,.95),rgba(192,57,43,.95)); color:#fff}
    .panel{
      background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:16px
    }
    .panel h2{margin:0 0 10px 0; font-size:16px; color:#fff}
    .grid2{display:grid; grid-template-columns:1.2fr .6fr .6fr; gap:10px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    .empty{padding:40px 12px; text-align:center; color:var(--muted); background:rgba(255,255,255,.02); border:1px solid var(--border); border-radius:12px}
    .sum{font-weight:800}
    .badge{background:rgba(255,255,255,.06); padding:6px 8px; border-radius:8px; border:1px solid var(--border)}
  </style>
</head>
<body>

  <div id="alertBox" class="alert"></div>

  <header>
    <h1>🛒 لوحة تحكم السوبر ماركت</h1>
    <div class="user-controls">
      <span class="badge">وضع الإدارة</span>
      <span class="user-name" id="displayName">...</span>
      <button class="btn secondary" id="gotoShop">🛍️ صفحة المشتري</button>
      <button class="btn" id="logoutBtn">🚪 خروج</button>
    </div>
  </header>

  <main>
    <!-- شريط أدوات -->
    <div class="toolbar">
      <div class="search">
        <input id="searchInput" placeholder="🔍 ابحث باسم المنتج..." />
        <select id="sortBy">
          <option value="name">فرز: الاسم</option>
          <option value="price">فرز: السعر</option>
          <option value="quantity">فرز: الكمية</option>
        </select>
        <button class="btn secondary" id="clearSearch">مسح</button>
      </div>
      <div class="row">
        <span class="badge">المنتجات: <b id="prodCount">0</b></span>
        <span class="badge">إجمالي الكمية: <b id="qtySum">0</b></span>
        <span class="badge">قيمة المخزون: <b id="valSum">0.00</b> ريال</span>
      </div>
    </div>

    <!-- إضافة/تعديل -->
    <div class="panel">
      <h2>➕ إضافة/تعديل منتج</h2>
      <div class="grid2" style="margin-bottom:10px">
        <input id="pName" placeholder="اسم المنتج" />
        <input id="pPrice" type="number" min="0" step="0.01" placeholder="السعر (ريال)" />
        <input id="pQty" type="number" min="0" step="1" placeholder="الكمية" />
      </div>
      <input id="pDesc" placeholder="وصف (اختياري)" style="width:100%; margin-bottom:10px" />
      <div class="row">
        <div class="actions">
          <button class="btn" id="addBtn">حفظ كمنتج جديد</button>
          <button class="btn warn" id="updateBtn" disabled>تحديث المنتج المحدد</button>
          <button class="btn secondary" id="resetBtn">تفريغ الحقول</button>
        </div>
        <div class="muted">تلميح: اضغط "تعديل" على بطاقة منتج لملء الحقول وتحديثه.</div>
      </div>
    </div>

    <!-- القائمة -->
    <div id="cards" class="cards"></div>
    <div id="emptyState" class="empty" style="display:none">لا توجد منتجات حالياً.</div>
  </main>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ===== إعدادات Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
      authDomain: "appjx-d8c22.firebaseapp.com",
      databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
      projectId: "appjx-d8c22",
      storageBucket: "appjx-d8c22.firebasestorage.app",
      messagingSenderId: "182238643819",
      appId: "1:182238643819:web:da345308cde59a9b8ed32e",
      measurementId: "G-MMZZ5Y7JK2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ===== السماح فقط لأدمن =====
    const adminEmails = [
      // ضع ايميل الأدمن/الأدمنز هنا
      "swd63431@gmail.com"
    ];

    function isAdmin(user){
      if (!user) return false;
      const email = (user.email || "").toLowerCase();
      return adminEmails.map(e=>e.toLowerCase()).includes(email);
    }

    // ===== عناصر DOM =====
    const displayNameEl = document.getElementById('displayName');
    const logoutBtn = document.getElementById('logoutBtn');
    const gotoShop = document.getElementById('gotoShop');

    const cardsEl = document.getElementById('cards');
    const emptyState = document.getElementById('emptyState');

    const searchInput = document.getElementById('searchInput');
    const sortBy = document.getElementById('sortBy');
    const clearSearch = document.getElementById('clearSearch');

    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pQty = document.getElementById('pQty');
    const pDesc = document.getElementById('pDesc');

    const addBtn = document.getElementById('addBtn');
    const updateBtn = document.getElementById('updateBtn');
    const resetBtn = document.getElementById('resetBtn');

    const prodCount = document.getElementById('prodCount');
    const qtySum = document.getElementById('qtySum');
    const valSum = document.getElementById('valSum');

    const alertBox = document.getElementById('alertBox');

    // حالة
    let currentUser = null;
    let products = {}; // {id: {name, price, quantity, desc}}
    let editId = null;

    // ===== تحقق تسجيل الدخول =====
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      if (!isAdmin(user)) {
        // لو مش أدمن، دخّله على صفحة المشتري
        window.location.href = "buyer.html";
        return;
      }
      currentUser = user;
      displayNameEl.textContent = user.displayName || user.email || 'أدمن';
      listenProducts();
    });

    // ===== الاستماع للمنتجات =====
    function listenProducts(){
      const productsRef = ref(db, 'products');
      onValue(productsRef, snap => {
        products = snap.val() || {};
        render();
        updateStats();
      }, err => {
        showAlert('خطأ في الاتصال بقاعدة البيانات', true);
      });
    }

    // ===== عرض البطاقات =====
    function render(){
      cardsEl.innerHTML = '';
      const q = searchInput.value.trim().toLowerCase();

      let list = Object.entries(products); // [id, obj]

      if (q) list = list.filter(([id,p]) => (p?.name||'').toLowerCase().includes(q));

      // sort
      const key = sortBy.value;
      list.sort((a,b)=>{
        const A = a[1] || {}, B = b[1] || {};
        if (key === 'name') return (A.name||'').localeCompare(B.name||'');
        if (key === 'price') return Number(A.price||0) - Number(B.price||0);
        if (key === 'quantity') return Number(A.quantity||0) - Number(B.quantity||0);
        return 0;
      });

      if (list.length === 0){
        emptyState.style.display = 'block';
        return;
      } else emptyState.style.display = 'none';

      list.forEach(([id, p])=>{
        const card = document.createElement('div');
        card.className = 'card';
        const price = Number(p.price||0).toFixed(2);
        const qty = Number(p.quantity||0);
        const desc = p.desc ? escapeHtml(p.desc) : '';

        card.innerHTML = `
          <div class="row">
            <div class="title">${escapeHtml(p.name||'منتج')}</div>
            <div class="chip">${price} ريال</div>
          </div>
          <div class="muted">${desc}</div>
          <div class="row">
            <div class="muted">الكمية: <b>${qty}</b></div>
            <div class="actions">
              <button class="btn secondary" data-edit="${id}">✏️ تعديل</button>
              <button class="btn danger" data-del="${id}">🗑️ حذف</button>
              <button class="btn warn" data-addone="${id}">➕ +1</button>
              <button class="btn warn" data-subone="${id}" ${qty===0?'disabled':''}>➖ -1</button>
            </div>
          </div>
        `;
        cardsEl.appendChild(card);
      });

      // events
      cardsEl.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=> loadIntoForm(btn.getAttribute('data-edit')));
      });
      cardsEl.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=> deleteProduct(btn.getAttribute('data-del')));
      });
      cardsEl.querySelectorAll('[data-addone]').forEach(btn=>{
        btn.addEventListener('click', ()=> incDec(btn.getAttribute('data-addone'), +1));
      });
      cardsEl.querySelectorAll('[data-subone]').forEach(btn=>{
        btn.addEventListener('click', ()=> incDec(btn.getAttribute('data-subone'), -1));
      });
    }

    function updateStats(){
      const vals = Object.values(products);
      const count = vals.length;
      const qSum = vals.reduce((s,p)=> s + Number(p.quantity||0), 0);
      const vSum = vals.reduce((s,p)=> s + Number(p.quantity||0)*Number(p.price||0), 0);
      prodCount.textContent = count;
      qtySum.textContent = qSum;
      valSum.textContent = vSum.toFixed(2);
    }

    // ===== نموذج الإضافة/التعديل =====
    addBtn.addEventListener('click', async ()=>{
      const {name, price, quantity, desc, err} = readForm();
      if (err){ showAlert(err, true); return; }
      try{
        const id = push(ref(db, 'products')).key;
        await set(ref(db, 'products/'+id), { name, price, quantity, desc });
        resetForm();
        showAlert('✅ تم إضافة المنتج بنجاح');
      }catch(e){ showAlert('حدث خطأ أثناء الإضافة', true); console.error(e); }
    });

    updateBtn.addEventListener('click', async ()=>{
      if (!editId){ showAlert('لا يوجد منتج مُحدد للتحديث', true); return; }
      const {name, price, quantity, desc, err} = readForm();
      if (err){ showAlert(err, true); return; }
      try{
        await update(ref(db, 'products/'+editId), { name, price, quantity, desc });
        resetForm();
        showAlert('✏️ تم تحديث المنتج');
      }catch(e){ showAlert('حدث خطأ أثناء التحديث', true); console.error(e); }
    });

    resetBtn.addEventListener('click', resetForm);

    function loadIntoForm(id){
      const p = products[id]; if (!p) return;
      pName.value = p.name || '';
      pPrice.value = Number(p.price||0);
      pQty.value = Number(p.quantity||0);
      pDesc.value = p.desc || '';
      editId = id;
      updateBtn.disabled = false;
      addBtn.disabled = true;
      showAlert('وضع التعديل مُفعل لهذا المنتج');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function resetForm(){
      pName.value = ''; pPrice.value=''; pQty.value=''; pDesc.value='';
      editId = null;
      updateBtn.disabled = true;
      addBtn.disabled = false;
    }

    function readForm(){
      const name = pName.value.trim();
      const price = parseFloat(pPrice.value);
      const quantity = parseInt(pQty.value);
      const desc = pDesc.value.trim();
      if (!name) return {err:'يرجى إدخال اسم المنتج'};
      if (isNaN(price) || price < 0) return {err:'يرجى إدخال سعر صحيح (>= 0)'};
      if (isNaN(quantity) || quantity < 0) return {err:'يرجى إدخال كمية صحيحة (>= 0)'};
      return {name, price, quantity, desc};
    }

    // حذف منتج
    async function deleteProduct(id){
      const p = products[id];
      if (!p) return;
      const ok = confirm(`هل تريد حذف "${p.name}"؟`);
      if (!ok) return;
      try{
        await remove(ref(db, 'products/'+id));
        if (editId === id) resetForm();
        showAlert('🗑️ تم حذف المنتج');
      }catch(e){ showAlert('تعذّر الحذف', true); console.error(e); }
    }

    // زيادة/إنقاص كمية (+1/-1) باستخدام transaction
    async function incDec(id, delta){
      const r = ref(db, 'products/'+id);
      try{
        await runTransaction(r, (cur)=>{
          if (!cur) return cur;
          const q = Number(cur.quantity||0) + delta;
          if (q < 0) return; // cancel
          return { ...cur, quantity: q };
        });
      }catch(e){ console.error(e); showAlert('تعذّر تحديث الكمية', true); }
    }

    // بحث/فرز
    searchInput.addEventListener('input', render);
    sortBy.addEventListener('change', render);
    clearSearch.addEventListener('click', ()=>{ searchInput.value=''; render(); });

    // تنقل وخروج
    gotoShop.addEventListener('click', ()=> window.location.href = 'buyer.html');
    logoutBtn.addEventListener('click', async ()=>{
      try{ await signOut(auth); }catch{}
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    });

    // ===== تنبيهات =====
    let alertTimer = null;
    function showAlert(msg, isError=false){
      clearTimeout(alertTimer);
      alertBox.textContent = msg;
      alertBox.className = 'alert ' + (isError ? 'error' : 'success');
      alertBox.style.display = 'block';
      alertTimer = setTimeout(()=> alertBox.style.display='none', 2200);
    }

    // ===== مساعد =====
    function escapeHtml(text){
      if (!text) return '';
      return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
