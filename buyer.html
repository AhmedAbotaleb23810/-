<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>Ø§Ù„Ù…Ø´ØªØ±ÙŠ â€” Ø§Ù„Ù…ØªØ¬Ø± ÙˆØ§Ù„Ø³Ù„Ø©</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
* { box-sizing: border-box; }
:root{
  --bg1: #0a1a2f; --bg2: #122b4a; --card-bg: rgba(255,255,255,0.04);
  --muted: #cbd8e3; --accent: #4da8da; --accent-dark: #27517d;
  --success: #27ae60; --danger: #e74c3c; --warning: #f39c12;
  --btn-gradient: linear-gradient(90deg,#4da8da,#27517d);
  --btn-gradient-hover: linear-gradient(90deg,#27517d,#4da8da);
}
body{
  margin:0;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(to right, var(--bg1), var(--bg2));
  color:#fff;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}
header{
  padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px;
  background: rgba(0,0,0,0.12); backdrop-filter: blur(4px); box-shadow: 0 4px 16px rgba(0,0,0,0.35);
  position:sticky; top:0; z-index:10;
}
header h1{ margin:0; font-size:20px; display:flex; align-items:center; gap:10px; }
.user-controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
.user-name{ font-weight:700; color:#fff; background:rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; }
.btn{
  background: var(--btn-gradient); color:#fff; border:none; padding:10px 14px; border-radius:10px; cursor:pointer;
  font-weight:700; transition: all .2s ease;
}
.btn:hover{ transform: translateY(-3px) scale(1.05); background: var(--btn-gradient-hover); }
.btn.secondary{ background: rgba(255,255,255,0.06); color: var(--muted); border:1px solid rgba(255,255,255,0.05); }
.btn.danger{ background: var(--danger); }
.btn.warn{ background: var(--warning); color:#1e1e1e; }
main{
  flex:1; /* Ù‡Ø°Ø§ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙŠØ¬Ø¹Ù„ Ø§Ù„Ù€footer Ø¯Ø§Ø¦Ù…Ù‹Ø§ ÙÙŠ Ø§Ù„Ø£Ø³ÙÙ„ */
  max-width:1100px;
  width:100%;
  margin:26px auto;
  padding:0 16px 60px;
}
.controls-row{ display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; margin-bottom:18px; }
.search{ display:flex; gap:8px; align-items:center; flex:1; min-width:240px; }
.search input{ flex:1; padding:12px 14px; border-radius:12px; border:none; background: rgba(255,255,255,0.06); color:#fff; outline:none; font-size:15px; }
.stats{ display:flex; gap:12px; flex-wrap:wrap; }
.stat-card{
  background: rgba(255,255,255,0.06); padding:12px 18px; border-radius:12px;
  display:flex; align-items:center; gap:8px; font-weight:700; transition: transform .15s ease, background .15s ease;
}
.stat-card:hover{ transform: translateY(-3px); background: rgba(255,255,255,0.1); }
.grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:18px; }
@media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, 1fr);} }
@media (max-width: 640px){ .grid{ grid-template-columns: 1fr;} }
.card{
  background: var(--card-bg); border-radius:12px; padding:16px; min-height:120px; /* ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„Ø§Ø±ØªÙØ§Ø¹ */
  display:flex; flex-direction:column; justify-content:space-between;
  border:1px solid rgba(255,255,255,0.05); box-shadow: 0 6px 18px rgba(0,0,0,0.35);
  transition: transform .15s ease, box-shadow .15s ease, background .15s ease;
}
.card:hover{ transform: translateY(-6px); box-shadow: 0 10px 28px rgba(0,0,0,0.45); background: rgba(255,255,255,0.08); }
.card .title{ font-size:17px; font-weight:800; color:#fff; margin-bottom:6px; }
.card .meta{ color:var(--muted); margin-top:4px; font-size:14px; min-height:36px; }
.card-footer{ display:flex; justify-content:space-between; align-items:center; gap:12px; margin-top:14px; flex-wrap:wrap; }
.badge{ background: rgba(255,255,255,0.06); padding:6px 10px; border-radius:8px; font-weight:700; }
.qty{ color: var(--muted); font-weight:700; }
.empty{
  text-align:center; color:var(--muted); padding:40px 12px;
  background: rgba(255,255,255,0.03); border-radius:12px; font-size:18px;
  display:flex; flex-direction:column; align-items:center; gap:12px;
}
.empty::before{ content:"ğŸ›’"; font-size:50px; }
.alert{
  position: fixed; left:50%; transform: translateX(-50%); top:16px;
  background: rgba(0,0,0,0.65); color:#fff; padding:10px 16px; border-radius:10px;
  display:none; z-index:1200; box-shadow: 0 6px 18px rgba(0,0,0,0.5);
}
.alert.success{ background: linear-gradient(90deg, rgba(39,174,96,0.95), rgba(30,132,73,0.95)); }
.alert.error{ background: linear-gradient(90deg, rgba(231,76,60,0.95), rgba(192,57,43,0.95)); }
.modal{ position: fixed; inset:0; display:none; justify-content:center; align-items:center; background: rgba(0,0,0,0.6); z-index:1500; padding:20px; }
.modal-content{
  width:100%; max-width:780px; background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.03));
  border-radius:12px; padding:18px; color:#fff; box-shadow: 0 10px 40px rgba(0,0,0,0.6);
  max-height:80vh; overflow:auto; border: 1px solid rgba(255,255,255,0.05);
}
.modal-content h2{ margin:0 0 12px 0; color: var(--accent); }
.list{ list-style:none; padding:0; margin:0; color:var(--muted); }
.list li{ padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.06); display:flex; align-items:center; justify-content:space-between; gap:8px; }
.controls-inline{ display:flex; align-items:center; gap:6px; }
footer{
  text-align:center; padding:20px; background: rgba(0,0,0,0.12); color:#fff; display:flex; flex-direction:column; align-items:center; gap:6px;
}
footer a{ color:#4da8da; text-decoration:none; transition: color .2s; }
footer a:hover{ color:#27517d; }
</style>
</head>
<body>
<div class="alert" id="alertBox"></div>

<header>
  <h1>ğŸ›ï¸ Ø§Ù„Ù…ØªØ¬Ø±</h1>
  <div class="user-controls">
    <div class="user-name" id="displayName">...</div>
    <button class="btn secondary" id="showCartBtn" onclick="window.location.href='cart.html'">ğŸ›’ Ø§Ù„Ø³Ù„Ø© (<span id="cartCount">0</span>)</button>
    <button class="btn secondary" id="showPurchBtn">ğŸ§¾ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</button>
    <button class="btn" id="logoutBtn">ğŸšª Ø®Ø±ÙˆØ¬</button>
  </div>
</header>

<main>
  <div class="controls-row">
    <div class="search">
      <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." />
      <button class="btn secondary" id="clearSearch">Ù…Ø³Ø­</button>
    </div>
    <div class="stats" id="statsBox"></div>
  </div>

  <div id="grid" class="grid"></div>
  <div id="emptyState" class="empty" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
</main>

<!-- Modal Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
<div id="purchModal" class="modal" aria-hidden="true">
  <div class="modal-content">
    <h2>ğŸ§¾ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
    <ul id="purchaseList" class="list"></ul>
    <button class="btn secondary" id="closePurchBtn">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<footer>
  <div>ğŸ“ <a href="tel:01002174432">01002174432</a></div>
  <div>ğŸ’¬ ÙˆØ§ØªØ³: <a href="https://wa.me/201002174432" target="_blank">01002174432</a></div>
  <div>âœ‰ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <a href="mailto:swd63431@gmail.com">swd63431@gmail.com</a></div>
  <div>Â© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© 2025</div>
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, onValue, get, set, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
  authDomain: "appjx-d8c22.firebaseapp.com",
  databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
  projectId: "appjx-d8c22",
  storageBucket: "appjx-d8c22.firebasestorage.app",
  messagingSenderId: "182238643819",
  appId: "1:182238643819:web:da345308cde59a9b8ed32e",
  measurementId: "G-MMZZ5Y7JK2"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

const gridEl = document.getElementById('grid');
const searchInput = document.getElementById('searchInput');
const clearSearch = document.getElementById('clearSearch');
const emptyState = document.getElementById('emptyState');
const statsBox = document.getElementById('statsBox');
const alertBox = document.getElementById('alertBox');
const cartCountEl = document.getElementById('cartCount');

const purchModal = document.getElementById('purchModal');
const purchaseListEl = document.getElementById('purchaseList');
const showPurchBtn = document.getElementById('showPurchBtn');
const closePurchBtn = document.getElementById('closePurchBtn');

const displayNameEl = document.getElementById('displayName');
const logoutBtn = document.getElementById('logoutBtn');

let currentUser = null;
let products = {};
let cart = {};
let purchases = [];

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    const local = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
    if (!local) { window.location.href = 'login.html'; return; }
    currentUser = { uid: local.uid || ('local-' + (local.email||local.username||'guest')), email: local.email || local.username || 'Ù…Ø³ØªØ®Ø¯Ù…', displayName: local.displayName || local.username || local.email };
  } else {
    currentUser = user;
  }
  displayNameEl.textContent = currentUser.displayName || currentUser.email || 'Ù…Ø³ØªØ®Ø¯Ù…';
  listenProducts();
  await loadCartFromDB();
  await loadPurchasesFromDB();
  renderCartBadge();
});

function listenProducts(){
  const productsRef = ref(db, 'products');
  onValue(productsRef, (snap) => {
    products = snap.val() || {};
    renderGrid();
    updateStats();
  }, () => showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true));
}

function renderGrid(){
  gridEl.innerHTML = '';
  const q = (searchInput.value || '').trim().toLowerCase();
  const entries = Object.entries(products);

  if (entries.length === 0){ emptyState.style.display = 'flex'; return; }
  else emptyState.style.display = 'none';

  const filtered = entries
    .filter(([id,p]) => p && (p.name||'').toLowerCase().includes(q))
    .sort((a,b) => (a[1].name||'').localeCompare(b[1].name||''));

  if (filtered.length === 0){ gridEl.innerHTML = '<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø­Ø«.</div>'; return; }

  filtered.forEach(([id, p]) => {
    const priceText = (typeof p.price === 'number') ? p.price.toFixed(2) : (Number(p.price||0)).toFixed(2);
    const qty = Number(p.quantity || 0);
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div>
        <div class="title">${escapeHtml(p.name || 'Ù…Ù†ØªØ¬')}</div>
        <div class="meta">${escapeHtml(p.desc || '')}</div>
      </div>
      <div class="card-footer">
        <div>
          <span class="badge">${priceText} Ø±ÙŠØ§Ù„</span>
          <div class="qty" style="margin-top:6px;">Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªØ§Ø­Ø©: <strong>${qty}</strong></div>
        </div>
        <div style="display:flex; gap:6px;">
          <button class="btn" data-id="${id}" ${qty <= 0 ? 'disabled' : ''}>â• Ø£Ø¶Ù Ù„Ù„Ø³Ù„Ø©</button>
        </div>
      </div>
    `;
    gridEl.appendChild(card);
  });

  gridEl.querySelectorAll('button.btn[data-id]').forEach(btn => {
    btn.addEventListener('click', () => addToCart(btn.getAttribute('data-id')));
  });
}

function updateStats(){
  statsBox.innerHTML = '';
  const totalCount = Object.values(products).reduce((s,p) => s + Number(p.quantity||0), 0);
  const prodCount = Object.keys(products).length;
  const cards = [
    {label:'Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª', value:prodCount},
    {label:'Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©', value:totalCount}
  ];
  cards.forEach(c => {
    const div = document.createElement('div');
    div.className = 'stat-card';
    div.textContent = `${c.label}: ${c.value}`;
    statsBox.appendChild(div);
  });
}

function renderCartBadge(){
  const count = Object.values(cart).reduce((sum,it)=> sum + Number(it.qty||0), 0);
  cartCountEl.textContent = count;
}

async function loadCartFromDB(){
  const uidKey = currentUser?.uid || ('local-' + (currentUser?.email || 'guest'));
  try { const snap = await get(ref(db, 'cart/' + uidKey)); cart = snap.val() || {}; } catch { cart = {}; }
  renderCartBadge();
}

async function saveCartToDB(){
  const uidKey = currentUser?.uid || ('local-' + (currentUser?.email || 'guest'));
  await set(ref(db, 'cart/' + uidKey), cart);
  renderCartBadge();
}

async function addToCart(productId){
  const p = products[productId];
  if (!p){ showAlert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', true); return; }
  const available = Number(p.quantity || 0);
  const currentQty = Number((cart[productId]?.qty) || 0);
  if (currentQty + 1 > available){ showAlert('Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ØºÙŠØ± Ù…ØªØ§Ø­Ø©', true); return; }
  cart[productId] = { name: p.name || 'Ù…Ù†ØªØ¬', price: Number(p.price || 0), qty: currentQty + 1 };
  await saveCartToDB();
  showAlert('ğŸ›’ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©');
}

async function loadPurchasesFromDB(){
  const uidKey = currentUser?.uid || ('local-' + (currentUser?.email || 'guest'));
  try { const snap = await get(ref(db, 'purchases/' + uidKey)); const val = snap.val() || {}; purchases = Object.values(val).sort((a,b) => new Date(b.time) - new Date(a.time)); } catch { purchases = []; }
}

function renderPurchases(){
  purchaseListEl.innerHTML = '';
  if (!purchases.length){
    purchaseListEl.innerHTML = '<li class="muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</li>';
    return;
  }
  purchases.forEach((it, idx) => {
    const timeText = it.time ? (new Date(it.time)).toLocaleString() : '';
    const qty = Number(it.qty||1);
    const total = (Number(it.price||0) * qty).toFixed(2);
    const li = document.createElement('li');
    li.innerHTML = `<div><strong>#${idx+1}</strong> â€” ${escapeHtml(it.name)} Ã— ${qty} = ${total} Ø±ÙŠØ§Ù„</div><div style="font-size:12px; color:var(--muted)">${timeText}</div>`;
    purchaseListEl.appendChild(li);
  });
}

function showAlert(msg, isError=false){
  alertBox.textContent = msg;
  alertBox.className = 'alert ' + (isError ? 'error' : 'success');
  alertBox.style.display='block';
  setTimeout(()=>{ alertBox.style.display='none'; }, 2800);
}

searchInput.addEventListener('input', renderGrid);
clearSearch.addEventListener('click', ()=>{ searchInput.value=''; renderGrid(); });

showPurchBtn.addEventListener('click', ()=>{ renderPurchases(); purchModal.style.display='flex'; });
closePurchBtn.addEventListener('click', ()=>{ purchModal.style.display='none'; });

logoutBtn.addEventListener('click', async ()=>{ try{ await signOut(auth); localStorage.removeItem('loggedInUser'); window.location.href='login.html'; } catch{ showAlert('Ø®Ø·Ø£ Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬', true); } });

function escapeHtml(text){ return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>

</body>
</html>




