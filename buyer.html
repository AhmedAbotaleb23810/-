<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ØµÙØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠ â€” Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    :root{
      --bg1: #0a1a2f;
      --bg2: #122b4a;
      --card-bg: rgba(255,255,255,0.04);
      --muted: #cbd8e3;
      --accent: #4da8da;
      --accent-dark: #27517d;
      --success: #27ae60;
      --danger: #e74c3c;
    }

    body{
      margin:0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(to right, var(--bg1), var(--bg2));
      color: #fff;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    header{
      padding:16px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background: rgba(0,0,0,0.12);
      backdrop-filter: blur(4px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }

    header h1{
      margin:0;
      font-size:20px;
      color:#fff;
      display:flex;
      align-items:center;
      gap:10px;
    }

    .user-controls{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .user-name{
      font-weight:600;
      color:var(--muted);
    }

    .btn {
      background: var(--accent);
      color: #fff;
      border: none;
      padding:10px 14px;
      border-radius:8px;
      cursor:pointer;
      font-weight:600;
      transition: transform .12s ease, background .15s ease;
    }
    .btn:hover { transform: translateY(-2px); background: var(--accent-dark); }
    .btn.secondary {
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.04);
    }

    main{
      max-width:1100px;
      margin:28px auto;
      padding:0 16px 60px;
      width:100%;
    }

    .controls-row{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      margin-bottom:18px;
      flex-wrap:wrap;
    }

    .search {
      display:flex;
      gap:8px;
      align-items:center;
      flex:1;
      min-width:220px;
    }

    .search input{
      flex:1;
      padding:12px 14px;
      border-radius:10px;
      border: none;
      background: rgba(255,255,255,0.03);
      color: #fff;
      outline:none;
      font-size:15px;
    }

    .stats{
      display:flex;
      gap:12px;
      align-items:center;
      color:var(--muted);
      font-weight:600;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:18px;
    }

    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, 1fr); }
    }
    @media (max-width: 640px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card-bg);
      border-radius:12px;
      padding:16px;
      min-height:120px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      box-shadow: 0 6px 18px rgba(0,0,0,0.35);
      transition: transform .12s ease, box-shadow .12s ease;
      border: 1px solid rgba(255,255,255,0.03);
    }
    .card:hover{ transform: translateY(-6px); box-shadow: 0 10px 28px rgba(0,0,0,0.45); }

    .card .title{
      font-size:17px;
      font-weight:700;
      color:#fff;
    }
    .card .meta{
      color: var(--muted);
      margin-top:8px;
      font-size:14px;
    }

    .card-footer{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-top:14px;
    }

    .price{
      background: rgba(255,255,255,0.03);
      padding:8px 10px;
      border-radius:8px;
      font-weight:700;
      color:#fff;
    }

    .qty{
      font-weight:700;
      color: var(--muted);
    }

    .buy-btn{
      padding:10px 14px;
      border-radius:8px;
      border:none;
      cursor:pointer;
      background: var(--accent);
      color:#fff;
      font-weight:700;
      transition: background .12s ease, transform .12s ease;
    }
    .buy-btn:hover{ background: var(--accent-dark); transform: translateY(-2px); }
    .buy-btn:disabled{
      background:#555;
      cursor:not-allowed;
      opacity:0.6;
      transform:none;
    }

    /* alert */
    .alert{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      top: 16px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      padding:10px 16px;
      border-radius:8px;
      display:none;
      z-index:1200;
      box-shadow: 0 6px 18px rgba(0,0,0,0.5);
    }
    .alert.success { background: linear-gradient(90deg, rgba(39,174,96,0.95), rgba(30,132,73,0.95)); }
    .alert.error { background: linear-gradient(90deg, rgba(231,76,60,0.95), rgba(192,57,43,0.95)); }

    /* modal */
    .modal{
      position: fixed;
      inset: 0;
      display: none;
      justify-content: center;
      align-items: center;
      background: rgba(0,0,0,0.6);
      z-index:1500;
      padding:20px;
    }
    .modal-content{
      width:100%;
      max-width:720px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:12px;
      padding:18px;
      color:#fff;
      box-shadow: 0 10px 40px rgba(0,0,0,0.6);
      max-height:80vh;
      overflow:auto;
      border: 1px solid rgba(255,255,255,0.04);
    }
    .modal-content h2{ margin:0 0 12px 0; color:var(--accent); }
    .purchase-list{ list-style:none; padding:0; margin:0; color:var(--muted); }
    .purchase-list li{ padding:10px 0; border-bottom: 1px solid rgba(255,255,255,0.03); }
    .modal-close{ margin-top:12px; background:var(--danger); border:none; color:#fff; padding:10px 14px; border-radius:8px; cursor:pointer; }

    /* empty state */
    .empty{
      text-align:center;
      color:var(--muted);
      padding:40px 12px;
      background: rgba(255,255,255,0.02);
      border-radius:12px;
    }
  </style>
</head>
<body>

  <div class="alert" id="alertBox"></div>

  <header>
    <h1>ğŸ›ï¸ Ø§Ù„Ù…ØªØ¬Ø±</h1>
    <div class="user-controls">
      <div class="user-name" id="displayName">...</div>
      <button class="btn secondary" id="showPurchBtn">ğŸ§¾ Ù…Ø´ØªØ±ÙŠØ§ØªÙŠ</button>
      <button class="btn" id="logoutBtn">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main>
    <div class="controls-row">
      <div class="search">
        <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬..." />
        <button class="btn secondary" id="clearSearch">Ù…Ø³Ø­</button>
      </div>
      <div class="stats" id="statsBox">
        <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø³Ø±ÙŠØ¹Ø© -->
      </div>
    </div>

    <div id="grid" class="grid"></div>
    <div id="emptyState" class="empty" style="display:none;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
  </main>

  <!-- Modal Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª -->
  <div id="modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h2>ğŸ§¾ Ø³Ø¬Ù„ Ù…Ø´ØªØ±ÙŠØ§ØªÙƒ</h2>
      <ul id="purchaseList" class="purchase-list"></ul>
      <button class="modal-close" id="closeModalBtn">Ø¥ØºÙ„Ø§Ù‚</button>
    </div>
  </div>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, push, child, get } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ---- Ø¶Ø¹ Ù‡Ù†Ø§ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù€ Firebase Ø§Ù„ØªÙŠ Ø£Ø±Ø³Ù„ØªÙ‡Ø§ ----
    const firebaseConfig = {
      apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
      authDomain: "appjx-d8c22.firebaseapp.com",
      databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
      projectId: "appjx-d8c22",
      storageBucket: "appjx-d8c22.firebasestorage.app",
      messagingSenderId: "182238643819",
      appId: "1:182238643819:web:da345308cde59a9b8ed32e",
      measurementId: "G-MMZZ5Y7JK2"
    };

    // initialize
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // Ø¹Ù†Ø§ØµØ± DOM
    const gridEl = document.getElementById('grid');
    const searchInput = document.getElementById('searchInput');
    const clearSearch = document.getElementById('clearSearch');
    const emptyState = document.getElementById('emptyState');
    const statsBox = document.getElementById('statsBox');
    const alertBox = document.getElementById('alertBox');
    const modal = document.getElementById('modal');
    const purchaseListEl = document.getElementById('purchaseList');
    const showPurchBtn = document.getElementById('showPurchBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const displayNameEl = document.getElementById('displayName');

    let currentUser = null;
    let products = {}; // object keyed by push id
    let purchases = []; // user's purchases

    // Check auth state
    onAuthStateChanged(auth, user => {
      if (!user) {
        // no logged in user -> try localStorage fallback (older pages used localStorage.loggedInUser)
        const local = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
        if (!local) {
          window.location.href = 'login.html';
          return;
        } else {
          // try to use local info (email/username) but still allow DB operations only with uid (we'll not have uid)
          // recommend to use Firebase Auth login flow; but we'll proceed with local identifier (username/email)
          currentUser = { uid: local.uid || ('local-' + (local.email||local.username||'guest')), email: local.email || local.username || 'Ù…Ø³ØªØ®Ø¯Ù…', displayName: local.displayName || local.username || local.email };
          displayNameEl.textContent = currentUser.displayName;
          listenProducts(); // start listening anyway; purchases will use local key under 'purchases/{uid}'
          loadUserPurchases();
          return;
        }
      }

      currentUser = user;
      displayNameEl.textContent = user.displayName || user.email || 'Ù…Ø³ØªØ®Ø¯Ù…';
      listenProducts();
      loadUserPurchases();
    });

    // Listen realtime products list
    function listenProducts(){
      const productsRef = ref(db, 'products');
      onValue(productsRef, snapshot => {
        const val = snapshot.val() || {};
        products = val;
        renderGrid();
        updateStats();
      }, err => {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true);
      });
    }

    // Render cards grid
    function renderGrid(){
      gridEl.innerHTML = '';
      const q = searchInput.value.trim().toLowerCase();
      const entries = Object.entries(products);

      if (entries.length === 0) {
        emptyState.style.display = 'block';
        return;
      } else emptyState.style.display = 'none';

      // filter and sort (by name)
      const filtered = entries.filter(([id, p]) => {
        if (!p || !p.name) return false;
        return p.name.toLowerCase().includes(q);
      }).sort((a,b) => (a[1].name || '').localeCompare(b[1].name || ''));

      if (filtered.length === 0) {
        gridEl.innerHTML = '<div class="empty">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù„Ù„Ø¨Ø­Ø«</div>';
        return;
      }

      filtered.forEach(([id, p]) => {
        const card = document.createElement('div');
        card.className = 'card';
        const priceText = (typeof p.price === 'number') ? p.price.toFixed(2) : (p.price || '0.00');
        const qty = Number(p.quantity || 0);

        card.innerHTML = `
          <div>
            <div class="title">${escapeHtml(p.name || 'Ù…Ù†ØªØ¬')}</div>
            <div class="meta">${(p.desc) ? escapeHtml(p.desc) : ''}</div>
          </div>
          <div class="card-footer">
            <div>
              <div class="price">${priceText} Ø±ÙŠØ§Ù„</div>
              <div class="qty" style="margin-top:6px;">Ø§Ù„ÙƒÙ…ÙŠØ©: ${qty}</div>
            </div>
            <div>
              <button class="buy-btn" ${qty === 0 ? 'disabled' : ''} data-id="${id}">ğŸ›’ Ø´Ø±Ø§Ø¡</button>
            </div>
          </div>
        `;
        gridEl.appendChild(card);
      });

      // attach buy handlers
      gridEl.querySelectorAll('.buy-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-id');
          handleBuy(id);
        });
      });
    }

    // handle buy with transaction
    async function handleBuy(productId){
      const productRef = ref(db, `products/${productId}`);
      try {
        await runTransaction(productRef, current => {
          if (current === null) {
            showAlert('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯', true);
            return;
          }
          const q = Number(current.quantity || 0);
          if (q <= 0) {
            showAlert('Ø§Ù„ÙƒÙ…ÙŠØ© ØºÙŠØ± Ù…ØªÙˆÙØ±Ø©', true);
            return; // abort transaction
          }
          current.quantity = q - 1;
          return current;
        });

        // Ø³Ø¬Ù„ Ø§Ù„Ø´Ø±Ø§Ø¡ ØªØ­Øª purchases/{uid}
        const uidKey = currentUser.uid || ('local-' + (currentUser.email || 'guest'));
        const purchasesRef = ref(db, `purchases/${uidKey}`);
        await push(purchasesRef, {
          name: products[productId].name || 'Ù…Ù†ØªØ¬',
          price: Number(products[productId].price || 0),
          time: new Date().toISOString()
        });

        showAlert('âœ… ØªÙ…Øª Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­!');
      } catch (err) {
        console.error(err);
        showAlert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø´Ø±Ø§Ø¡: ' + (err.message || err), true);
      }
    }

    // load user's purchases (one-time load)
    async function loadUserPurchases(){
      purchaseListEl.innerHTML = '';
      try {
        const uidKey = currentUser.uid || ('local-' + (currentUser.email || 'guest'));
        const purchasesRef = ref(db, `purchases/${uidKey}`);
        const snap = await get(purchasesRef);
        const val = snap.val() || {};
        purchases = Object.values(val).sort((a,b) => new Date(b.time) - new Date(a.time));
        // fill list when modal opens (we also keep purchases array)
      } catch (err) {
        console.error(err);
        // not fatal
      }
    }

    // show purchases modal
    showPurchBtn.addEventListener('click', async () => {
      // refresh before showing
      await loadUserPurchasesFromDB();
      renderPurchasesModal();
      modal.style.display = 'flex';
      modal.setAttribute('aria-hidden','false');
    });

    async function loadUserPurchasesFromDB(){
      try {
        const uidKey = currentUser.uid || ('local-' + (currentUser.email || 'guest'));
        const purchasesRef = ref(db, `purchases/${uidKey}`);
        const snap = await get(purchasesRef);
        const val = snap.val() || {};
        purchases = Object.values(val).sort((a,b) => new Date(b.time) - new Date(a.time));
      } catch (err) {
        console.error(err);
      }
    }

    function renderPurchasesModal(){
      purchaseListEl.innerHTML = '';
      if (!purchases || purchases.length === 0) {
        purchaseListEl.innerHTML = '<li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø´ØªØ±ÙŠØ§Øª Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.</li>';
        return;
      }
      purchases.forEach((it, idx) => {
        const li = document.createElement('li');
        const timeText = it.time ? (new Date(it.time)).toLocaleString() : '';
        li.textContent = `#${idx+1} - ${it.name} - ${Number(it.price || 0).toFixed(2)} Ø±ÙŠØ§Ù„ - ${timeText}`;
        purchaseListEl.appendChild(li);
      });
    }

    closeModalBtn.addEventListener('click', () => {
      modal.style.display = 'none';
      modal.setAttribute('aria-hidden','true');
    });
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        modal.style.display = 'none';
        modal.setAttribute('aria-hidden','true');
      }
    });

    // logout
    logoutBtn.addEventListener('click', async () => {
      try {
        await signOut(auth);
      } catch (err) {
        // If signOut fails (e.g. local fallback), still clear localStorage fallback
      }
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    });

    // search handlers
    searchInput.addEventListener('input', renderGrid);
    clearSearch.addEventListener('click', () => { searchInput.value=''; renderGrid(); });

    // small stats update
    function updateStats(){
      const totalCount = Object.values(products).reduce((s,p) => s + Number(p.quantity || 0), 0);
      const prodCount = Object.keys(products).length;
      statsBox.innerHTML = `<div>Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <strong>${prodCount}</strong></div><div>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: <strong>${totalCount}</strong></div>`;
    }

    // show alert
    let alertTimer = null;
    function showAlert(msg, isError=false){
      clearTimeout(alertTimer);
      alertBox.textContent = msg;
      alertBox.className = 'alert ' + (isError ? 'error' : 'success');
      alertBox.style.display = 'block';
      alertTimer = setTimeout(()=>{ alertBox.style.display='none'; }, 2200);
    }

    // helper escape
    function escapeHtml(text){
      if (!text) return '';
      return String(text).replace(/[&<>"']/g, function (m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }

    // initial fallback: if auth hasn't fired in 2s, try localStorage
    setTimeout(() => {
      if (!currentUser) {
        const local = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
        if (local) {
          currentUser = { uid: local.uid || ('local-' + (local.email||local.username||'guest')), email: local.email || local.username || 'Ù…Ø³ØªØ®Ø¯Ù…', displayName: local.displayName || local.username || local.email };
          displayNameEl.textContent = currentUser.displayName;
          listenProducts();
          loadUserPurchases();
        }
      }
    }, 1500);

  </script>
</body>
</html>
