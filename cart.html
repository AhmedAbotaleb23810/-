<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
:root{
  --bg1:#0a1a2f; --bg2:#122b4a; --card:rgba(255,255,255,0.06);
  --muted:#cbd8e3; --accent:#4da8da; --accent-dark:#27517d;
  --danger:#e74c3c; --success:#27ae60;
}
*{ box-sizing:border-box; }
body{
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(to right, var(--bg1), var(--bg2));
  color: #fff; margin:0; padding:0; min-height:100vh; display:flex; flex-direction:column;
}
header{
  padding:16px; background: rgba(0,0,0,0.2);
  display:flex; justify-content:space-between; align-items:center; gap:10px;
  position: sticky; top:0; z-index:10; backdrop-filter: blur(4px);
}
h2{ margin:0; font-size:20px; }
.btn{
  background: var(--accent); border:none; color:#fff; padding:10px 14px;
  border-radius:10px; cursor:pointer; font-weight:700;
  transition: transform .12s ease, background .15s ease, opacity .15s ease;
}
.btn:hover{ transform: translateY(-2px); background: var(--accent-dark); }
.btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }
.btn.secondary{ background: rgba(255,255,255,0.1); }
.btn.danger{ background: var(--danger); }
.btn.ghost{ background: transparent; border:1px solid rgba(255,255,255,0.15); }
main{ width:100%; max-width:1000px; margin:auto; padding:20px; flex:1; }
.card{
  background: var(--card); border-radius:14px; padding:16px; border:1px solid rgba(255,255,255,0.08);
  box-shadow:0 8px 24px rgba(0,0,0,0.35);
}
.cart-item{
  display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center;
  padding:12px; border-radius:12px; margin-bottom:10px; background: rgba(255,255,255,0.04);
  border:1px solid rgba(255,255,255,0.06);
}
.muted{ color: var(--muted); font-size:14px; }
.controls-inline{ display:flex; gap:6px; align-items:center; }
.qty-input{
  width:70px; padding:6px; border:none; border-radius:6px;
  font-size:15px; text-align:center; background: rgba(255,255,255,0.12); color:#fff;
}
.total-row{
  display:flex; justify-content:space-between; align-items:center; margin-top:10px; font-weight:800;
}
.section-title{ margin: 18px 0 10px; font-size:18px; color:#fff; }
.payment .methods{
  display:flex; gap:10px; flex-wrap:wrap; margin-top:8px;
}
.chip{
  background: rgba(255,255,255,0.08); border:1px solid rgba(255,255,255,0.12);
  padding:10px 12px; border-radius:999px; cursor:pointer; user-select:none;
}
.chip input{ margin-inline-start:6px; }
.payment-form{
  margin-top:14px; display:none;
  background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.12);
  border-radius:14px; padding:14px;
}
.row{ display:grid; grid-template-columns: 1fr 1fr; gap:10px; }
@media (max-width:700px){ .row{ grid-template-columns: 1fr; } }
label{ font-weight:700; display:block; margin:6px 0 6px; }
input[type=text], input[type=number]{
  width:100%; padding:10px; border-radius:10px; border:none; outline:none; font-size:15px;
  background: rgba(255,255,255,0.1); color:#fff;
}
.hint{ font-size:12px; color: var(--muted); }
.sticky-bar{
  position: sticky; bottom:0; background: rgba(0,0,0,0.45);
  backdrop-filter: blur(6px); border-radius:14px; padding:12px; margin-top:16px;
  display:flex; justify-content:space-between; align-items:center; gap:10px;
}
.empty{ text-align:center; padding:30px; color:var(--muted); }
.shipping-address{
  margin-top: 20px; padding: 16px; background: rgba(255, 255, 255, 0.06);
  border-radius: 12px; display: flex; flex-direction: column; gap: 12px;
}
.shipping-address input{
  padding: 10px; border-radius: 8px; border: none; outline: none; font-size: 15px;
}
.stock-badge{ font-size:12px; color:#fff; background: rgba(255,255,255,0.15); padding:3px 8px; border-radius:999px; display:inline-block; margin-top:6px; }
.stock-low{ background: rgba(231, 76, 60, 0.35); }
.item-total{ font-weight:700; }
</style>
</head>
<body>
<header>
  <h2>ğŸ›’ Ø³Ù„Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠØ§Øª</h2>
  <div class="controls-inline">
    <button class="btn secondary" onclick="window.location.href='buyer.html'">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØªØ³ÙˆÙ‚</button>
    <button class="btn ghost" id="refreshBtn">â†» ØªØ­Ø¯ÙŠØ«</button>
  </div>
</header>
<main>
  <div class="card" id="cartCard">
    <div id="cartItems"></div>
    <div class="total-row">
      <div>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</div>
      <div><span id="cartTotal">0.00</span> Ø±ÙŠØ§Ù„</div>
    </div>
  </div>

  <div class="shipping-address">
    <label for="shippingAddress">ğŸ“¦ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù†</label>
    <input type="text" id="shippingAddress" placeholder="Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù† Ø§Ù„ÙƒØ§Ù…Ù„" />
  </div>

  <div class="card payment" style="margin-top:14px;">
    <div class="section-title">ğŸ’³ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹</div>
    <div class="methods">
      <label class="chip"><input type="radio" name="paymentMethod" value="cod" checked> ğŸ’µ Ø¯ÙØ¹ Ø¹Ù†Ø¯ Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</label>
      <label class="chip"><input type="radio" name="paymentMethod" value="card"> ğŸ’³ Ø¨Ø·Ø§Ù‚Ø© (ÙÙŠØ²Ø§/Ù…Ø§Ø³ØªØ±)</label>
      <label class="chip"><input type="radio" name="paymentMethod" value="bank"> ğŸ¦ ØªØ­ÙˆÙŠÙ„ Ø¨Ù†ÙƒÙŠ</label>
    </div>
    <div class="payment-form" id="cardForm">
      <div class="row">
        <div>
          <label>Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
          <input type="text" id="cardName" placeholder="Ù…Ø«Ø§Ù„: AHMED MOHAMED" />
        </div>
        <div>
          <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©</label>
          <input type="text" id="cardNumber" placeholder="#### #### #### ####" maxlength="19" />
        </div>
      </div>
      <div class="row">
        <div>
          <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (MM/YY)</label>
          <input type="text" id="expiry" placeholder="MM/YY" maxlength="5" />
        </div>
        <div>
          <label>CVV</label>
          <input type="text" id="cvv" placeholder="3-4 Ø£Ø±Ù‚Ø§Ù…" maxlength="4" />
        </div>
      </div>
    </div>
  </div>

  <div class="sticky-bar">
    <div>Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù†Ø§ØµØ±: <strong id="itemsCount">0</strong></div>
    <div class="controls-inline">
      <button class="btn danger" id="clearBtn">ØªÙØ±ÙŠØº Ø§Ù„Ø³Ù„Ø©</button>
      <button class="btn" id="checkoutBtn">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡</button>
    </div>
  </div>
</main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getDatabase, ref, get, set, runTransaction, push } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

// === Firebase ===
const firebaseConfig = {
  apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
  authDomain: "appjx-d8c22.firebaseapp.com",
  databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
  projectId: "appjx-d8c22",
  storageBucket: "appjx-d8c22.firebasestorage.app",
  messagingSenderId: "182238643819",
  appId: "1:182238643819:web:da345308cde59a9b8ed32e",
  measurementId: "G-MMZZ5Y7JK2"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

// === State ===
let currentUser = null;
let cart = {};
let products = {}; // ÙŠØ­ØªÙˆÙŠ ÙƒÙ„ Ù…Ù†ØªØ¬ Ø¹Ù„Ù‰ quantity (Ø§Ù„Ù…Ø®Ø²ÙˆÙ†)

// === UI refs ===
const cartItems = document.getElementById('cartItems');
const cartTotalEl = document.getElementById('cartTotal');
const itemsCountEl = document.getElementById('itemsCount');
const clearBtn = document.getElementById('clearBtn');
const checkoutBtn = document.getElementById('checkoutBtn');
const refreshBtn = document.getElementById('refreshBtn');
const cardForm = document.getElementById('cardForm');
const methodRadios = document.querySelectorAll('input[name="paymentMethod"]');

// Ø¥Ø¸Ù‡Ø§Ø± Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø±Ù‡Ø§
methodRadios.forEach(r => r.addEventListener('change', (e) => {
  cardForm.style.display = (e.target.value === 'card') ? 'block' : 'none';
}));

// === Auth bootstrap ===
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    const local = JSON.parse(localStorage.getItem('loggedInUser') || 'null');
    if (!local) { window.location.href = 'login.html'; return; }
    currentUser = { uid: local.uid || ('local-' + (local.email||local.username||'guest')), email: local.email || 'guest@example.com' };
  } else {
    currentUser = user;
  }
  await loadProducts();
  await loadCart();
  // Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ Ù‚ÙÙ… Ø¨Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ù…Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ùˆ ÙÙŠ ØªØ¬Ø§ÙˆØ²
  await normalizeCartAgainstStock();
  renderCart();
});

// === Data ===
async function loadProducts(){
  const snap = await get(ref(db, 'products'));
  products = snap.val() || {};
}
async function loadCart(){
  const snap = await get(ref(db, 'cart/' + currentUser.uid));
  cart = snap.val() || {};
}
async function saveCart(){
  await set(ref(db, 'cart/' + currentUser.uid), cart);
}

// ÙŠØ±Ø¬Ø¹ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­ Ù„Ù…Ù†ØªØ¬ Ù…Ø¹ÙŠÙ‘Ù†
function getStock(id){
  const p = products[id];
  const q = p && p.quantity != null ? Number(p.quantity) : Infinity; // Ù„Ùˆ Ù…ÙÙŠØ´ quantity Ù†Ø¹ØªØ¨Ø±Ù‡ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯
  return isNaN(q) ? Infinity : q;
}

// Ø¶Ø¨Ø· Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù…Ø¹ ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©)
async function normalizeCartAgainstStock(){
  let adjusted = [];
  for (const [id, it] of Object.entries(cart)) {
    const stock = getStock(id);
    if (stock === Infinity) continue;
    if (it.qty > stock) {
      cart[id].qty = Math.max(0, stock);
      adjusted.push(`${it.name} â†’ ${stock}`);
    }
  }
  if (adjusted.length){
    await saveCart();
    alert("ØªÙ… Ø¶Ø¨Ø· ÙƒÙ…ÙŠØ§Øª Ø¨Ø¹Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆÙÙ‚Ù‹Ø§ Ù„Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­:\n" + adjusted.join("\n"));
  }
}

// === Rendering ===
function renderCart(){
  cartItems.innerHTML = '';
  let total = 0; let count = 0;

  for (const [id, item] of Object.entries(cart)) {
    const qty = Math.max(0, Number(item.qty) || 0);
    const price = Number(item.price) || 0;
    const stock = getStock(id);
    const perItemTotal = qty * price;

    total += perItemTotal;
    count += qty;

    // Ø­Ø§Ù„Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
    const outOfStock = (stock !== Infinity && stock <= 0);
    const atMax = (stock !== Infinity && qty >= stock);
    const atMin = qty <= 1;

    const stockText = (stock === Infinity) ? 'Ø§Ù„Ù…ØªØ§Ø­: ØºÙŠØ± Ù…Ø­Ø¯Ø¯' :
                      (stock <= 0 ? 'ØºÙŠØ± Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ†' : `Ø§Ù„Ù…ØªØ§Ø­: ${stock}`);

    const div = document.createElement('div');
    div.className = 'cart-item';
    div.innerHTML = `
      <div>
        <strong>${item.name}</strong>
        <div class="muted">${price.toFixed(2)} Ø±ÙŠØ§Ù„ Ã— ${qty} = <span class="item-total">${perItemTotal.toFixed(2)} Ø±ÙŠØ§Ù„</span></div>
        <div class="stock-badge ${stock <= 3 ? 'stock-low' : ''}">${stockText}</div>
      </div>
      <div class="controls-inline">
        <button class="btn ghost" ${atMin ? 'disabled' : ''} onclick="updateQty('${id}', ${qty - 1})">â–</button>
        <input type="number" class="qty-input" value="${qty}" ${stock !== Infinity ? `max="${Math.max(0, stock)}"`:''} min="1" ${outOfStock ? 'disabled' : ''} oninput="updateQty('${id}', this.value)">
        <button class="btn ghost" ${atMax || outOfStock ? 'disabled' : ''} onclick="updateQty('${id}', ${qty + 1})">â•</button>
        <button class="btn danger" onclick="removeItem('${id}')">ğŸ—‘ Ø­Ø°Ù</button>
      </div>`;
    cartItems.appendChild(div);
  }

  if (!Object.keys(cart).length) {
    cartItems.innerHTML = '<div class="empty">Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©</div>';
  }

  cartTotalEl.textContent = total.toFixed(2);
  itemsCountEl.textContent = count;
}

// === Actions (global for inline handlers) ===
window.updateQty = async function(id, newQty){
  newQty = parseInt(newQty);
  if (isNaN(newQty)) return;

  // Ø­Ø¯ Ø£Ø¯Ù†Ù‰ 1
  if (newQty < 1) newQty = 1;

  // Ø­Ø¯ Ø£Ù‚ØµÙ‰ = Ø§Ù„Ù…Ø®Ø²ÙˆÙ†
  const stock = getStock(id);
  if (stock !== Infinity && newQty > stock) {
    newQty = stock;
    alert('Ù‡Ø°Ù‡ Ø§Ù„ÙƒÙ…ÙŠØ© ØªØªØ¬Ø§ÙˆØ² Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…ØªØ§Ø­. ØªÙ… Ø¶Ø¨Ø·Ù‡Ø§ Ø¥Ù„Ù‰ ' + stock);
  }

  // Ù„Ùˆ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§
  if (stock !== Infinity && stock <= 0) {
    alert('Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªÙˆÙØ± Ø¨Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø­Ø§Ù„ÙŠÙ‹Ø§. ÙŠØ±Ø¬Ù‰ Ø¥Ø²Ø§Ù„ØªÙ‡ Ù…Ù† Ø§Ù„Ø³Ù„Ø©.');
    renderCart();
    return;
  }

  if (!cart[id]) return; // Ø­Ù…Ø§ÙŠØ©
  cart[id].qty = newQty;
  await saveCart();
  renderCart();
}

window.removeItem = async function(id){
  delete cart[id];
  await saveCart();
  renderCart();
}

// === Bulk actions ===
clearBtn.onclick = async () => { cart = {}; await saveCart(); renderCart(); };

checkoutBtn.onclick = async () => {
  if (!Object.keys(cart).length) return alert('Ø§Ù„Ø³Ù„Ø© ÙØ§Ø±ØºØ©');

  // ØªØ­Ù‚Ù‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  const address = document.getElementById('shippingAddress').value.trim();
  if (!address) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø´Ø­Ù†');

  // ØªØ­Ù‚Ù‚ Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø¯ÙØ¹
  const method = document.querySelector('input[name="paymentMethod"]:checked').value;
  if (method === 'card') {
    const name = document.getElementById('cardName').value.trim();
    const number = document.getElementById('cardNumber').value.trim();
    const expiry = document.getElementById('expiry').value.trim();
    const cvv = document.getElementById('cvv').value.trim();
    if (!name || !number || !expiry || !cvv) return alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©');
  }

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø«Ù… ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù„Ø­Ø¸ÙŠÙ‹Ø§
  await loadProducts();
  let issues = [];
  for (const [id, it] of Object.entries(cart)) {
    const stock = getStock(id);
    if (stock === Infinity) continue;
    if (stock <= 0) issues.push(`${it.name}: ØºÙŠØ± Ù…ØªÙˆÙØ±`);
    else if (it.qty > stock) {
      cart[id].qty = stock;
      issues.push(`${it.name}: ØªÙ… ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ…ÙŠØ© Ø¥Ù„Ù‰ ${stock}`);
    }
  }
  if (issues.length){
    await saveCart();
    renderCart();
    alert('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù„Ø© Ù„ØªÙˆØ§ÙÙ‚ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ù‚Ø¨Ù„ Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡:\n' + issues.join('\n'));
    return; // Ø®Ù„ÙŠ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙŠØ±Ø§Ø¬Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
  }

  // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨
  const orderData = {
    userEmail: currentUser.email || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
    address,
    payment: method,
    status: 'pending',
    date: Date.now(),
    items: Object.fromEntries(Object.entries(cart).map(([id, it]) => [
      id, { name: it.name, price: it.price, quantity: it.qty }
    ]))
  };
  await push(ref(db, 'orders'), orderData);

  // Ø®ØµÙ… Ø§Ù„Ù…Ø®Ø²ÙˆÙ† (Ù†ÙØªØ±Ø¶ Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø³Ø§Ø¨Ù‚ ÙƒØ§ÙÙŠ)
  for (const [id, it] of Object.entries(cart)) {
    await runTransaction(ref(db, 'products/' + id), current => {
      if (!current) return current;
      const available = Number(current.quantity) || 0;
      const qty = Number(it.qty) || 0;
      current.quantity = Math.max(0, available - qty);
      return current;
    });
  }

  cart = {}; await saveCart(); renderCart();
  alert('ØªÙ… Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø´Ø±Ø§Ø¡ Ø¨Ù†Ø¬Ø§Ø­');
};

refreshBtn.onclick = async () => { await loadProducts(); await loadCart(); await normalizeCartAgainstStock(); renderCart(); };

</script>
</body>
</html>
