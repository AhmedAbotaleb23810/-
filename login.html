<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ â€” Ø§Ù„Ù…ØªØ¬Ø±</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg1:#0a1a2f; --bg2:#122b4a; --card:#1e2d3f; --accent:#4da8da; --accent-dark:#27517d; --muted:#cbd8e3;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(90deg,var(--bg1),var(--bg2));
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
    }
    .card{
      width:100%;
      max-width:420px;
      background: linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border-radius:12px;
      padding:26px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.5);
      border:1px solid rgba(255,255,255,0.04);
    }
    .brand{
      display:flex;
      align-items:center;
      gap:12px;
      margin-bottom:14px;
    }
    .logo{
      font-size:34px;
      background:var(--accent);
      width:56px;height:56px;border-radius:10px;
      display:flex;align-items:center;justify-content:center;color:#fff;box-shadow:0 6px 16px rgba(0,0,0,0.4);
    }
    h1{margin:0;font-size:20px}
    p.sub{margin:6px 0 18px;color:var(--muted);font-size:14px}

    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input[type="email"], input[type="password"]{
      width:100%;
      padding:12px 14px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.02);
      color:#fff;
      font-size:15px;
      outline:none;
      margin-bottom:12px;
    }
    input::placeholder{color:rgba(255,255,255,0.45)}

    .row{display:flex;gap:10px;align-items:center}
    .btn{
      display:inline-block;
      padding:10px 14px;
      border-radius:10px;
      border:none;
      cursor:pointer;
      font-weight:700;
      background:var(--accent);
      color:#fff;
      transition:background .12s ease, transform .08s ease;
    }
    .btn.secondary{
      background: rgba(255,255,255,0.06);
      color:var(--muted);
      border:1px solid rgba(255,255,255,0.03);
      font-weight:600;
    }
    .btn:hover{transform:translateY(-2px)}
    .links{margin-top:12px;text-align:center;color:var(--muted);font-size:14px}
    .links a{color:var(--accent);text-decoration:none;font-weight:700}
    .msg{margin-top:12px;padding:10px;border-radius:8px;display:none}

    .msg.error{background:linear-gradient(90deg,#e74c3c,#c0392b); color:#fff}
    .msg.info{background:linear-gradient(90deg,#27ae60,#1e8449); color:#fff}

    @media (max-width:480px){
      .card{padding:18px}
    }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="signin-title">
    <div class="brand">
      <div class="logo">ğŸ”</div>
      <div>
        <h1 id="signin-title">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
        <p class="sub">Ø£Ø¯Ø®Ù„ Ø­Ø³Ø§Ø¨Ùƒ Ù„Ù„Ø¯Ø®ÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ù…ØªØ¬Ø±</p>
      </div>
    </div>

    <label for="email">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
    <input id="email" type="email" placeholder="example@email.com" autocomplete="email" />

    <label for="password">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
    <input id="password" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="current-password" />

    <div class="row" style="margin-top:6px;">
      <button class="btn" id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
      <button class="btn secondary" id="guestBtn">Ø¯Ø®ÙˆÙ„ ÙƒØ²Ø§Ø¦Ø±</button>
    </div>

    <!-- Ø²Ø± Ø¬ÙˆØ¬Ù„ Ø¨Ø¹Ø±Ø¶ Ø§Ù„ÙƒØ§Ø±Øª -->
    <button class="btn secondary" id="googleBtn" style="width:100%;margin-top:10px;display:flex;align-items:center;justify-content:center;gap:8px">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" style="width:20px;height:20px">
      Ø¯Ø®ÙˆÙ„ Ø¨ÙˆØ§Ø³Ø·Ø© Ø¬ÙˆØ¬Ù„
    </button>

    <div id="message" class="msg" role="status" aria-live="polite"></div>

    <div class="links">
      <div>Ù…Ø§ Ø¹Ù†Ø¯ÙƒØ´ Ø­Ø³Ø§Ø¨ØŸ <a href="register.html">Ø³Ø¬Ù‘Ù„ Ø§Ù„Ø¢Ù†</a></div>
      <div style="margin-top:6px"><a href="#" id="forgot">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±ØŸ</a></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getDatabase, ref, get, set } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
      authDomain: "appjx-d8c22.firebaseapp.com",
      databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
      projectId: "appjx-d8c22",
      storageBucket: "appjx-d8c22.firebasestorage.app",
      messagingSenderId: "182238643819",
      appId: "1:182238643819:web:da345308cde59a9b8ed32e",
      measurementId: "G-MMZZ5Y7JK2"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const emailEl = document.getElementById('email');
    const passEl = document.getElementById('password');
    const loginBtn = document.getElementById('loginBtn');
    const guestBtn = document.getElementById('guestBtn');
    const googleBtn = document.getElementById('googleBtn');
    const msgEl = document.getElementById('message');
    const forgotEl = document.getElementById('forgot');

    function showMsg(text, type='error', ms=3000){
      msgEl.textContent = text;
      msgEl.className = 'msg ' + (type==='error' ? 'error' : 'info');
      msgEl.style.display = 'block';
      setTimeout(()=>{ msgEl.style.display = 'none'; }, ms);
    }

    loginBtn.addEventListener('click', async () => {
      const email = emailEl.value.trim();
      const password = passEl.value;
      if (!email || !password) { showMsg('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±', 'error'); return; }
      loginBtn.disabled = true;
      loginBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
      try {
        const cred = await signInWithEmailAndPassword(auth, email, password);
        const user = cred.user;
        const userRef = ref(db, 'users/' + user.uid);
        const snap = await get(userRef);
        let role = 'buyer';
        let displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Ù…Ø³ØªØ®Ø¯Ù…');
        if (!snap.exists()) {
          await set(userRef, {
            email: user.email || null,
            displayName,
            role,
            createdAt: new Date().toISOString()
          });
        } else {
          const data = snap.val();
          role = data.role || 'buyer';
          displayName = data.displayName || displayName;
        }
        localStorage.setItem('loggedInUser', JSON.stringify({ uid: user.uid, email: user.email, displayName, role }));
        if (role === 'seller') {
          window.location.href = 'seller.html';
        } else {
          window.location.href = 'buyer.html';
        }
      } catch (err) {
        console.error(err);
        showMsg(err.message || 'Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 'error', 4000);
      } finally {
        loginBtn.disabled = false;
        loginBtn.textContent = 'Ø¯Ø®ÙˆÙ„';
      }
    });

    guestBtn.addEventListener('click', () => {
      const guest = { uid: 'local-guest-'+Date.now(), email: 'guest@guest', displayName: 'Ø²Ø§Ø¦Ø±', role: 'buyer' };
      localStorage.setItem('loggedInUser', JSON.stringify(guest));
      window.location.href = 'buyer.html';
    });

    forgotEl.addEventListener('click', async (e) => {
      e.preventDefault();
      const email = prompt('Ø£Ø¯Ø®Ù„ Ø¨Ø±ÙŠØ¯Ùƒ Ù„Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:');
      if (!email) return;
      try {
        await sendPasswordResetEmail(auth, email);
        alert('Ø£Ø±Ø³Ù„Ù†Ø§ Ø±Ø§Ø¨Ø· Ø§Ø³ØªØ¹Ø§Ø¯Ø© ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹');
      } catch (err) {
        alert('Ø®Ø·Ø£: ' + (err.message || err));
      }
    });

    // Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„
    const provider = new GoogleAuthProvider();
    googleBtn.addEventListener('click', async () => {
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;
        const userRef = ref(db, 'users/' + user.uid);
        const snap = await get(userRef);
        let role = 'buyer';
        let displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'Ù…Ø³ØªØ®Ø¯Ù…');
        if (!snap.exists()) {
          await set(userRef, {
            email: user.email || null,
            displayName,
            role,
            createdAt: new Date().toISOString()
          });
        } else {
          const data = snap.val();
          role = data.role || 'buyer';
          displayName = data.displayName || displayName;
        }
        localStorage.setItem('loggedInUser', JSON.stringify({ uid: user.uid, email: user.email, displayName, role }));
        if (role === 'seller') {
          window.location.href = 'seller.html';
        } else {
          window.location.href = 'buyer.html';
        }
      } catch (err) {
        console.error(err);
        showMsg(err.message || 'ØªØ¹Ø°Ø± ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„', 'error');
      }
    });

    passEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') loginBtn.click(); });
    emailEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') loginBtn.click(); });
  </script>
</body>
</html>

