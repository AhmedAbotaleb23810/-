<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… â€” Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#0a1a2f; --bg2:#122b4a;
      --card:#0f213a; --muted:#cbd8e3;
      --accent:#4da8da; --accent-dark:#27517d;
      --success:#27ae60; --danger:#e74c3c; --warn:#f39c12;
      --border:rgba(255,255,255,0.08);
    }
    body{
      margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(to right,var(--bg1),var(--bg2)); color:#fff;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:rgba(0,0,0,0.12); backdrop-filter:blur(4px); box-shadow:0 4px 16px rgba(0,0,0,.35);
    }
    header h1{margin:0; font-size:20px; display:flex; gap:10px; align-items:center}
    .user-controls{display:flex; gap:10px; align-items:center}
    .user-name{font-weight:600; color:var(--muted)}
    .btn{
      background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px;
      font-weight:700; cursor:pointer; transition:transform .12s ease,background .15s ease;
    }
    .btn:hover{transform:translateY(-2px); background:var(--accent-dark)}
    .btn.secondary{background:rgba(255,255,255,.06); color:var(--muted); border:1px solid var(--border)}
    .btn.danger{background:var(--danger)}
    .btn.warn{background:var(--warn); color:#222}
    main{max-width:1150px; margin:26px auto; padding:0 16px 70px; width:100%}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .search{display:flex; gap:8px; align-items:center; flex:1; min-width:220px}
    input, select{
      background:rgba(255,255,255,.05); color:#fff; border:1px solid var(--border);
      padding:10px 12px; border-radius:10px; outline:none; font-size:14px;
    }
    input::placeholder{color:#9fb3c6}
    .cards{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    @media (max-width:1000px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px;
      display:flex; flex-direction:column; gap:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{transform:translateY(-5px); box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .title{font-size:17px; font-weight:800}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .chip{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:8px; border:1px solid var(--border); font-weight:700}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .alert{
      position:fixed; left:50%; transform:translateX(-50%); top:16px; z-index:1200; display:none;
      padding:10px 16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.5);
    }
    .alert.success{background:linear-gradient(90deg,rgba(39,174,96,.95),rgba(30,132,73,.95)); color:#fff}
    .alert.error{background:linear-gradient(90deg,rgba(231,76,60,.95),rgba(192,57,43,.95)); color:#fff}
    .panel{
      background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:16px
    }
    .panel h2{margin:0 0 10px 0; font-size:16px; color:#fff}
    .grid2{display:grid; grid-template-columns:1.2fr .6fr .6fr; gap:10px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    .empty{padding:40px 12px; text-align:center; color:var(--muted); background:rgba(255,255,255,.02); border:1px solid var(--border); border-radius:12px}
    .sum{font-weight:800}
    .badge{background:rgba(255,255,255,.06); padding:6px 8px; border-radius:8px; border:1px solid var(--border)}
  </style>
</head>
<body>

  <div id="alertBox" class="alert"></div>

  <header>
    <h1>ğŸ›’ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø³ÙˆØ¨Ø± Ù…Ø§Ø±ÙƒØª</h1>
    <div class="user-controls">
      <span class="badge">ÙˆØ¶Ø¹ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
      <span class="user-name" id="displayName">...</span>
      <button class="btn secondary" id="gotoShop">ğŸ›ï¸ ØµÙØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠ</button>
      <button class="btn" id="logoutBtn">ğŸšª Ø®Ø±ÙˆØ¬</button>
    </div>
  </header>

  <main>
    <!-- Ø´Ø±ÙŠØ· Ø£Ø¯ÙˆØ§Øª -->
    <div class="toolbar">
      <div class="search">
        <input id="searchInput" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬..." />
        <select id="sortBy">
          <option value="name">ÙØ±Ø²: Ø§Ù„Ø§Ø³Ù…</option>
          <option value="price">ÙØ±Ø²: Ø§Ù„Ø³Ø¹Ø±</option>
          <option value="quantity">ÙØ±Ø²: Ø§Ù„ÙƒÙ…ÙŠØ©</option>
        </select>
        <button class="btn secondary" id="clearSearch">Ù…Ø³Ø­</button>
      </div>
      <div class="row">
        <span class="badge">Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª: <b id="prodCount">0</b></span>
        <span class="badge">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ©: <b id="qtySum">0</b></span>
        <span class="badge">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø®Ø²ÙˆÙ†: <b id="valSum">0.00</b> Ø±ÙŠØ§Ù„</span>
      </div>
    </div>

    <!-- Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ -->
    <div class="panel">
      <h2>â• Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…Ù†ØªØ¬</h2>
      <div class="grid2" style="margin-bottom:10px">
        <input id="pName" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬" />
        <input id="pPrice" type="number" min="0" step="0.01" placeholder="Ø§Ù„Ø³Ø¹Ø± (Ø±ÙŠØ§Ù„)" />
        <input id="pQty" type="number" min="0" step="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ©" />
      </div>
      <input id="pDesc" placeholder="ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)" style="width:100%; margin-bottom:10px" />
      <div class="row">
        <div class="actions">
          <button class="btn" id="addBtn">Ø­ÙØ¸ ÙƒÙ…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯</button>
          <button class="btn warn" id="updateBtn" disabled>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„Ù…Ø­Ø¯Ø¯</button>
          <button class="btn secondary" id="resetBtn">ØªÙØ±ÙŠØº Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
        </div>
        <div class="muted">ØªÙ„Ù…ÙŠØ­: Ø§Ø¶ØºØ· "ØªØ¹Ø¯ÙŠÙ„" Ø¹Ù„Ù‰ Ø¨Ø·Ø§Ù‚Ø© Ù…Ù†ØªØ¬ Ù„Ù…Ù„Ø¡ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙˆØªØ­Ø¯ÙŠØ«Ù‡.</div>
      </div>
    </div>

    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© -->
    <div id="cards" class="cards"></div>
    <div id="emptyState" class="empty" style="display:none">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>
  </main>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, update, remove, runTransaction } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ===== Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
      authDomain: "appjx-d8c22.firebaseapp.com",
      databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
      projectId: "appjx-d8c22",
      storageBucket: "appjx-d8c22.firebasestorage.app",
      messagingSenderId: "182238643819",
      appId: "1:182238643819:web:da345308cde59a9b8ed32e",
      measurementId: "G-MMZZ5Y7JK2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ===== Ø§Ù„Ø³Ù…Ø§Ø­ ÙÙ‚Ø· Ù„Ø£Ø¯Ù…Ù† =====
    const adminEmails = [
      // Ø¶Ø¹ Ø§ÙŠÙ…ÙŠÙ„ Ø§Ù„Ø£Ø¯Ù…Ù†/Ø§Ù„Ø£Ø¯Ù…Ù†Ø² Ù‡Ù†Ø§
      "swd63431@gmail.com"
    ];

    function isAdmin(user){
      if (!user) return false;
      const email = (user.email || "").toLowerCase();
      return adminEmails.map(e=>e.toLowerCase()).includes(email);
    }

    // ===== Ø¹Ù†Ø§ØµØ± DOM =====
    const displayNameEl = document.getElementById('displayName');
    const logoutBtn = document.getElementById('logoutBtn');
    const gotoShop = document.getElementById('gotoShop');

    const cardsEl = document.getElementById('cards');
    const emptyState = document.getElementById('emptyState');

    const searchInput = document.getElementById('searchInput');
    const sortBy = document.getElementById('sortBy');
    const clearSearch = document.getElementById('clearSearch');

    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pQty = document.getElementById('pQty');
    const pDesc = document.getElementById('pDesc');

    const addBtn = document.getElementById('addBtn');
    const updateBtn = document.getElementById('updateBtn');
    const resetBtn = document.getElementById('resetBtn');

    const prodCount = document.getElementById('prodCount');
    const qtySum = document.getElementById('qtySum');
    const valSum = document.getElementById('valSum');

    const alertBox = document.getElementById('alertBox');

    // Ø­Ø§Ù„Ø©
    let currentUser = null;
    let products = {}; // {id: {name, price, quantity, desc}}
    let editId = null;

    // ===== ØªØ­Ù‚Ù‚ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }
      if (!isAdmin(user)) {
        // Ù„Ùˆ Ù…Ø´ Ø£Ø¯Ù…Ù†ØŒ Ø¯Ø®Ù‘Ù„Ù‡ Ø¹Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ù…Ø´ØªØ±ÙŠ
        window.location.href = "buyer.html";
        return;
      }
      currentUser = user;
      displayNameEl.textContent = user.displayName || user.email || 'Ø£Ø¯Ù…Ù†';
      listenProducts();
    });

    // ===== Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª =====
    function listenProducts(){
      const productsRef = ref(db, 'products');
      onValue(productsRef, snap => {
        products = snap.val() || {};
        render();
        updateStats();
      }, err => {
        showAlert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', true);
      });
    }

    // ===== Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª =====
    function render(){
      cardsEl.innerHTML = '';
      const q = searchInput.value.trim().toLowerCase();

      let list = Object.entries(products); // [id, obj]

      if (q) list = list.filter(([id,p]) => (p?.name||'').toLowerCase().includes(q));

      // sort
      const key = sortBy.value;
      list.sort((a,b)=>{
        const A = a[1] || {}, B = b[1] || {};
        if (key === 'name') return (A.name||'').localeCompare(B.name||'');
        if (key === 'price') return Number(A.price||0) - Number(B.price||0);
        if (key === 'quantity') return Number(A.quantity||0) - Number(B.quantity||0);
        return 0;
      });

      if (list.length === 0){
        emptyState.style.display = 'block';
        return;
      } else emptyState.style.display = 'none';

      list.forEach(([id, p])=>{
        const card = document.createElement('div');
        card.className = 'card';
        const price = Number(p.price||0).toFixed(2);
        const qty = Number(p.quantity||0);
        const desc = p.desc ? escapeHtml(p.desc) : '';

        card.innerHTML = `
          <div class="row">
            <div class="title">${escapeHtml(p.name||'Ù…Ù†ØªØ¬')}</div>
            <div class="chip">${price} Ø±ÙŠØ§Ù„</div>
          </div>
          <div class="muted">${desc}</div>
          <div class="row">
            <div class="muted">Ø§Ù„ÙƒÙ…ÙŠØ©: <b>${qty}</b></div>
            <div class="actions">
              <button class="btn secondary" data-edit="${id}">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
              <button class="btn danger" data-del="${id}">ğŸ—‘ï¸ Ø­Ø°Ù</button>
              <button class="btn warn" data-addone="${id}">â• +1</button>
              <button class="btn warn" data-subone="${id}" ${qty===0?'disabled':''}>â– -1</button>
            </div>
          </div>
        `;
        cardsEl.appendChild(card);
      });

      // events
      cardsEl.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.addEventListener('click', ()=> loadIntoForm(btn.getAttribute('data-edit')));
      });
      cardsEl.querySelectorAll('[data-del]').forEach(btn=>{
        btn.addEventListener('click', ()=> deleteProduct(btn.getAttribute('data-del')));
      });
      cardsEl.querySelectorAll('[data-addone]').forEach(btn=>{
        btn.addEventListener('click', ()=> incDec(btn.getAttribute('data-addone'), +1));
      });
      cardsEl.querySelectorAll('[data-subone]').forEach(btn=>{
        btn.addEventListener('click', ()=> incDec(btn.getAttribute('data-subone'), -1));
      });
    }

    function updateStats(){
      const vals = Object.values(products);
      const count = vals.length;
      const qSum = vals.reduce((s,p)=> s + Number(p.quantity||0), 0);
      const vSum = vals.reduce((s,p)=> s + Number(p.quantity||0)*Number(p.price||0), 0);
      prodCount.textContent = count;
      qtySum.textContent = qSum;
      valSum.textContent = vSum.toFixed(2);
    }

    // ===== Ù†Ù…ÙˆØ°Ø¬ Ø§Ù„Ø¥Ø¶Ø§ÙØ©/Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ =====
    addBtn.addEventListener('click', async ()=>{
      const {name, price, quantity, desc, err} = readForm();
      if (err){ showAlert(err, true); return; }
      try{
        const id = push(ref(db, 'products')).key;
        await set(ref(db, 'products/'+id), { name, price, quantity, desc });
        resetForm();
        showAlert('âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­');
      }catch(e){ showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø¥Ø¶Ø§ÙØ©', true); console.error(e); }
    });

    updateBtn.addEventListener('click', async ()=>{
      if (!editId){ showAlert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬ Ù…ÙØ­Ø¯Ø¯ Ù„Ù„ØªØ­Ø¯ÙŠØ«', true); return; }
      const {name, price, quantity, desc, err} = readForm();
      if (err){ showAlert(err, true); return; }
      try{
        await update(ref(db, 'products/'+editId), { name, price, quantity, desc });
        resetForm();
        showAlert('âœï¸ ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬');
      }catch(e){ showAlert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ø¯ÙŠØ«', true); console.error(e); }
    });

    resetBtn.addEventListener('click', resetForm);

    function loadIntoForm(id){
      const p = products[id]; if (!p) return;
      pName.value = p.name || '';
      pPrice.value = Number(p.price||0);
      pQty.value = Number(p.quantity||0);
      pDesc.value = p.desc || '';
      editId = id;
      updateBtn.disabled = false;
      addBtn.disabled = true;
      showAlert('ÙˆØ¶Ø¹ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ÙÙØ¹Ù„ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬');
      window.scrollTo({top:0, behavior:'smooth'});
    }

    function resetForm(){
      pName.value = ''; pPrice.value=''; pQty.value=''; pDesc.value='';
      editId = null;
      updateBtn.disabled = true;
      addBtn.disabled = false;
    }

    function readForm(){
      const name = pName.value.trim();
      const price = parseFloat(pPrice.value);
      const quantity = parseInt(pQty.value);
      const desc = pDesc.value.trim();
      if (!name) return {err:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬'};
      if (isNaN(price) || price < 0) return {err:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¹Ø± ØµØ­ÙŠØ­ (>= 0)'};
      if (isNaN(quantity) || quantity < 0) return {err:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ…ÙŠØ© ØµØ­ÙŠØ­Ø© (>= 0)'};
      return {name, price, quantity, desc};
    }

    // Ø­Ø°Ù Ù…Ù†ØªØ¬
    async function deleteProduct(id){
      const p = products[id];
      if (!p) return;
      const ok = confirm(`Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù "${p.name}"ØŸ`);
      if (!ok) return;
      try{
        await remove(ref(db, 'products/'+id));
        if (editId === id) resetForm();
        showAlert('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬');
      }catch(e){ showAlert('ØªØ¹Ø°Ù‘Ø± Ø§Ù„Ø­Ø°Ù', true); console.error(e); }
    }

    // Ø²ÙŠØ§Ø¯Ø©/Ø¥Ù†Ù‚Ø§Øµ ÙƒÙ…ÙŠØ© (+1/-1) Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… transaction
    async function incDec(id, delta){
      const r = ref(db, 'products/'+id);
      try{
        await runTransaction(r, (cur)=>{
          if (!cur) return cur;
          const q = Number(cur.quantity||0) + delta;
          if (q < 0) return; // cancel
          return { ...cur, quantity: q };
        });
      }catch(e){ console.error(e); showAlert('ØªØ¹Ø°Ù‘Ø± ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒÙ…ÙŠØ©', true); }
    }

    // Ø¨Ø­Ø«/ÙØ±Ø²
    searchInput.addEventListener('input', render);
    sortBy.addEventListener('change', render);
    clearSearch.addEventListener('click', ()=>{ searchInput.value=''; render(); });

    // ØªÙ†Ù‚Ù„ ÙˆØ®Ø±ÙˆØ¬
    gotoShop.addEventListener('click', ()=> window.location.href = 'buyer.html');
    logoutBtn.addEventListener('click', async ()=>{
      try{ await signOut(auth); }catch{}
      localStorage.removeItem('loggedInUser');
      window.location.href = 'login.html';
    });

    // ===== ØªÙ†Ø¨ÙŠÙ‡Ø§Øª =====
    let alertTimer = null;
    function showAlert(msg, isError=false){
      clearTimeout(alertTimer);
      alertBox.textContent = msg;
      alertBox.className = 'alert ' + (isError ? 'error' : 'success');
      alertBox.style.display = 'block';
      alertTimer = setTimeout(()=> alertBox.style.display='none', 2200);
    }

    // ===== Ù…Ø³Ø§Ø¹Ø¯ =====
    function escapeHtml(text){
      if (!text) return '';
      return String(text).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
  </script>
</body>
</html>
