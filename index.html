<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>لوحة التحكم — السوبر ماركت</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    *{box-sizing:border-box}
    :root{
      --bg1:#0a1a2f; --bg2:#122b4a;
      --card:#0f213a; --muted:#cbd8e3;
      --accent:#4da8da; --accent-dark:#27517d;
      --success:#27ae60; --danger:#e74c3c; --warn:#f39c12;
      --border:rgba(255,255,255,0.08);
    }
    body{
      margin:0; font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;
      background:linear-gradient(to right,var(--bg1),var(--bg2)); color:#fff;
      min-height:100vh; display:flex; flex-direction:column;
    }
    header{
      padding:16px 20px; display:flex; align-items:center; justify-content:space-between; gap:12px;
      background:rgba(0,0,0,0.12); backdrop-filter:blur(4px); box-shadow:0 4px 16px rgba(0,0,0,.35);
    }
    header h1{margin:0; font-size:20px; display:flex; gap:10px; align-items:center}
    .user-controls{display:flex; gap:10px; align-items:center}
    .user-name{font-weight:600; color:var(--muted)}
    .btn{
      background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px;
      font-weight:700; cursor:pointer; transition:transform .12s ease,background .15s ease;
    }
    .btn:hover{transform:translateY(-2px); background:var(--accent-dark)}
    .btn.secondary{background:rgba(255,255,255,.06); color:var(--muted); border:1px solid var(--border)}
    .btn.danger{background:var(--danger)}
    .btn.warn{background:var(--warn); color:#222}
    .btn.ghost{background:transparent; border:1px dashed var(--border); color:var(--muted)}
    main{max-width:1150px; margin:26px auto; padding:0 16px 70px; width:100%}
    .toolbar{display:flex; gap:12px; flex-wrap:wrap; align-items:center; margin-bottom:16px}
    .search{display:flex; gap:8px; align-items:center; flex:1; min-width:220px}
    input, select{
      background:rgba(255,255,255,.05); color:#fff; border:1px solid var(--border);
      padding:10px 12px; border-radius:10px; outline:none; font-size:14px;
    }
    input::placeholder{color:#9fb3c6}
    .cards{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    @media (max-width:1000px){.cards{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:640px){.cards{grid-template-columns:1fr}}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:12px; padding:14px;
      display:flex; flex-direction:column; gap:10px; box-shadow:0 6px 18px rgba(0,0,0,.35);
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .card:hover{transform:translateY(-5px); box-shadow:0 10px 28px rgba(0,0,0,.45)}
    .title{font-size:17px; font-weight:800}
    .muted{color:var(--muted); font-size:13px}
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .chip{background:rgba(255,255,255,.06); padding:6px 10px; border-radius:8px; border:1px solid var(--border); font-weight:700}
    .actions{display:flex; gap:8px; flex-wrap:wrap}
    .alert{
      position:fixed; left:50%; transform:translateX(-50%); top:16px; z-index:1200; display:none;
      padding:10px 16px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,.5);
    }
    .alert.success{background:linear-gradient(90deg,rgba(39,174,96,.95),rgba(30,132,73,.95)); color:#fff}
    .alert.error{background:linear-gradient(90deg,rgba(231,76,60,.95),rgba(192,57,43,.95)); color:#fff}
    .panel{
      background:rgba(255,255,255,.04); border:1px solid var(--border); border-radius:12px; padding:14px; margin-bottom:16px
    }
    .panel h2{margin:0 0 10px 0; font-size:16px; color:#fff}
    .grid2{display:grid; grid-template-columns:1.2fr .6fr .6fr; gap:10px}
    @media (max-width:640px){.grid2{grid-template-columns:1fr}}
    .empty{padding:40px 12px; text-align:center; color:var(--muted); background:rgba(255,255,255,.02); border:1px solid var(--border); border-radius:12px}
    .sum{font-weight:800}
    .badge{background:rgba(255,255,255,.06); padding:6px 8px; border-radius:8px; border:1px solid var(--border)}
    /* Orders table */
    table{width:100%; border-collapse:collapse}
    th,td{padding:10px; border-bottom:1px solid var(--border); text-align:center}
    .status{padding:4px 8px; border-radius:999px; font-weight:700; font-size:12px; display:inline-block}
    .s-pending{background:rgba(243,156,18,.18); border:1px solid rgba(243,156,18,.4)}
    .s-confirmed{background:rgba(46,204,113,.18); border:1px solid rgba(46,204,113,.4)}
    .s-completed{background:rgba(52,152,219,.18); border:1px solid rgba(52,152,219,.4)}
    .s-cancelled{background:rgba(231,76,60,.18); border:1px solid rgba(231,76,60,.4)}
  </style>
</head>
<body>

  <div id="alertBox" class="alert"></div>

  <header>
    <h1>🛒 لوحة تحكم السوبر ماركت</h1>
    <div class="user-controls">
      <span class="badge">وضع الإدارة</span>
      <span class="user-name" id="displayName">...</span>
      <button class="btn secondary" id="gotoShop">🛍️ صفحة المشتري</button>
      <button class="btn" id="logoutBtn">🚪 خروج</button>
    </div>
  </header>

  <main>
    <!-- شريط أدوات المنتجات -->
    <div class="toolbar">
      <div class="search">
        <input id="searchInput" placeholder="🔍 ابحث باسم المنتج..." />
        <select id="sortBy">
          <option value="name">فرز: الاسم</option>
          <option value="price">فرز: السعر</option>
          <option value="quantity">فرز: الكمية</option>
        </select>
        <button class="btn secondary" id="clearSearch">مسح</button>
      </div>
      <div class="row">
        <span class="badge">المنتجات: <b id="prodCount">0</b></span>
        <span class="badge">إجمالي الكمية: <b id="qtySum">0</b></span>
        <span class="badge">قيمة المخزون: <b id="valSum">0.00</b> ريال</span>
      </div>
    </div>

    <!-- إضافة/تعديل منتج -->
    <div class="panel">
      <h2>➕ إضافة/تعديل منتج</h2>
      <div class="grid2" style="margin-bottom:10px">
        <input id="pName" placeholder="اسم المنتج" />
        <input id="pPrice" type="number" min="0" step="0.01" placeholder="السعر (ريال)" />
        <input id="pQty" type="number" min="0" step="1" placeholder="الكمية" />
      </div>
      <input id="pDesc" placeholder="وصف (اختياري)" style="width:100%; margin-bottom:10px" />
      <div class="row">
        <div class="actions">
          <button class="btn" id="addBtn">حفظ كمنتج جديد</button>
          <button class="btn warn" id="updateBtn" disabled>تحديث المنتج المحدد</button>
          <button class="btn secondary" id="resetBtn">تفريغ الحقول</button>
        </div>
        <div class="muted">تلميح: اضغط "تعديل" على بطاقة منتج لملء الحقول وتحديثه.</div>
      </div>
    </div>

    <!-- بطاقات المنتجات -->
    <div id="cards" class="cards"></div>
    <div id="emptyState" class="empty" style="display:none">لا توجد منتجات حالياً.</div>

    <!-- الطلبات (أسفل) -->
    <div class="panel" style="margin-top:24px">
      <h2>📦 الطلبات الواردة</h2>
      <div class="toolbar" style="margin-top:6px">
        <div class="search" style="flex:unset">
          <select id="orderFilter">
            <option value="all">الكل</option>
            <option value="pending">قيد المعالجة</option>
            <option value="confirmed">مؤكد</option>
            <option value="completed">مكتمل</option>
            <option value="cancelled">ملغي</option>
          </select>
        </div>
        <span class="badge">عدد الطلبات: <b id="ordersCount">0</b></span>
      </div>

      <div style="overflow:auto">
        <table id="ordersTable">
          <thead>
            <tr>
              <th>العميل</th>
              <th>الإجمالي</th>
              <th>طريقة الدفع</th>
              <th>الحالة</th>
              <th>التاريخ</th>
              <th>العناصر</th>
              <th>العنوان</th>
              <th>إجراءات</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div id="ordersEmpty" class="empty" style="display:none">لا توجد طلبات بعد.</div>
    </div>

  </main>

  <!-- Firebase (modular) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import {
      getDatabase, ref, onValue, push, set, update, remove, runTransaction
    } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";

    // ===== إعدادات Firebase =====
    const firebaseConfig = {
      apiKey: "AIzaSyDm2WxkPe15845RS5RnTNZnRnlm1SMbSAM",
      authDomain: "appjx-d8c22.firebaseapp.com",
      databaseURL: "https://appjx-d8c22-default-rtdb.firebaseio.com",
      projectId: "appjx-d8c22",
      storageBucket: "appjx-d8c22.firebasestorage.app",
      messagingSenderId: "182238643819",
      appId: "1:182238643819:web:da345308cde59a9b8ed32e",
            measurementId: "G-MMZZ5Y7JK2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);

    // ===== إعداد الأدمن =====
    const adminEmails = ["swd63431@gmail.com"];
    function isAdmin(user){
      return user && adminEmails.includes(user.email.toLowerCase());
    }

    // عناصر DOM
    const displayNameEl = document.getElementById('displayName');
    const logoutBtn = document.getElementById('logoutBtn');
    const gotoShop = document.getElementById('gotoShop');

    const cardsEl = document.getElementById('cards');
    const emptyState = document.getElementById('emptyState');
    const searchInput = document.getElementById('searchInput');
    const sortBy = document.getElementById('sortBy');
    const clearSearch = document.getElementById('clearSearch');
    const pName = document.getElementById('pName');
    const pPrice = document.getElementById('pPrice');
    const pQty = document.getElementById('pQty');
    const pDesc = document.getElementById('pDesc');
    const addBtn = document.getElementById('addBtn');
    const updateBtn = document.getElementById('updateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const prodCount = document.getElementById('prodCount');
    const qtySum = document.getElementById('qtySum');
    const valSum = document.getElementById('valSum');
    const alertBox = document.getElementById('alertBox');

    const ordersTableBody = document.querySelector('#ordersTable tbody');
    const ordersEmpty = document.getElementById('ordersEmpty');
    const ordersCount = document.getElementById('ordersCount');
    const orderFilter = document.getElementById('orderFilter');

    let currentUser = null;
    let products = {};
    let editId = null;
    let orders = {};

    // تحقق من تسجيل الدخول
    onAuthStateChanged(auth, user => {
      if (!user) return window.location.href = "login.html";
      if (!isAdmin(user)) return window.location.href = "buyer.html";
      currentUser = user;
      displayNameEl.textContent = user.displayName || user.email;
      listenProducts();
      listenOrders();
    });

    // المنتجات
    function listenProducts(){
      onValue(ref(db, 'products'), snap => {
        products = snap.val() || {};
        renderProducts();
        updateStats();
      });
    }

    function renderProducts(){
      cardsEl.innerHTML = '';
      const q = searchInput.value.trim().toLowerCase();
      let list = Object.entries(products);
      if (q) list = list.filter(([id,p]) => (p.name||'').toLowerCase().includes(q));
      list.sort((a,b)=>{
        if (sortBy.value==='name') return a[1].name.localeCompare(b[1].name);
        if (sortBy.value==='price') return a[1].price - b[1].price;
        if (sortBy.value==='quantity') return a[1].quantity - b[1].quantity;
        return 0;
      });
      if (!list.length) { emptyState.style.display='block'; return; }
      emptyState.style.display='none';
      list.forEach(([id,p])=>{
        const card=document.createElement('div');
        card.className='card';
        card.innerHTML=`
          <div class="row"><div class="title">${p.name}</div><div class="chip">${p.price} ريال</div></div>
          <div class="muted">${p.desc||''}</div>
          <div class="row">
            <div class="muted">الكمية: <b>${p.quantity}</b></div>
            <div class="actions">
              <button class="btn secondary" data-edit="${id}">✏️ تعديل</button>
              <button class="btn danger" data-del="${id}">🗑️ حذف</button>
              <button class="btn warn" data-add="${id}">➕ +1</button>
              <button class="btn warn" data-sub="${id}" ${p.quantity===0?'disabled':''}>➖ -1</button>
            </div>
          </div>`;
        cardsEl.appendChild(card);
      });
      cardsEl.querySelectorAll('[data-edit]').forEach(b=>b.onclick=()=>loadForm(b.dataset.edit));
      cardsEl.querySelectorAll('[data-del]').forEach(b=>b.onclick=()=>deleteProduct(b.dataset.del));
      cardsEl.querySelectorAll('[data-add]').forEach(b=>b.onclick=()=>changeQty(b.dataset.add,1));
      cardsEl.querySelectorAll('[data-sub]').forEach(b=>b.onclick=()=>changeQty(b.dataset.sub,-1));
    }

    function updateStats(){
      const vals=Object.values(products);
      prodCount.textContent=vals.length;
      qtySum.textContent=vals.reduce((s,p)=>s+(p.quantity||0),0);
      valSum.textContent=vals.reduce((s,p)=>s+(p.price||0)*(p.quantity||0),0).toFixed(2);
    }

    addBtn.onclick=async()=>{
      const d=readForm(); if(d.err) return alertMsg(d.err,true);
      const id=push(ref(db,'products')).key;
      await set(ref(db,'products/'+id),d);
      resetForm(); alertMsg('تمت الإضافة');
    };
    updateBtn.onclick=async()=>{
      if(!editId) return;
      const d=readForm(); if(d.err) return alertMsg(d.err,true);
      await update(ref(db,'products/'+editId),d);
      resetForm(); alertMsg('تم التحديث');
    };
    resetBtn.onclick=resetForm;

    function loadForm(id){ const p=products[id];
      pName.value=p.name; pPrice.value=p.price; pQty.value=p.quantity; pDesc.value=p.desc||'';
      editId=id; addBtn.disabled=true; updateBtn.disabled=false;
    }
    function resetForm(){ pName.value=''; pPrice.value=''; pQty.value=''; pDesc.value=''; editId=null; addBtn.disabled=false; updateBtn.disabled=true; }
    function readForm(){
      const name=pName.value.trim(), price=parseFloat(pPrice.value), quantity=parseInt(pQty.value), desc=pDesc.value.trim();
      if(!name) return {err:'ادخل الاسم'};
      if(isNaN(price)||price<0) return {err:'ادخل سعر صحيح'};
      if(isNaN(quantity)||quantity<0) return {err:'ادخل كمية صحيحة'};
      return {name,price,quantity,desc};
    }
    async function deleteProduct(id){ if(!confirm('حذف المنتج؟'))return; await remove(ref(db,'products/'+id)); alertMsg('تم الحذف'); }
    async function changeQty(id,delta){
      await runTransaction(ref(db,'products/'+id),cur=>{ if(cur){cur.quantity=Math.max(0,(cur.quantity||0)+delta);} return cur; });
    }

    searchInput.oninput=renderProducts;
    sortBy.onchange=renderProducts;
    clearSearch.onclick=()=>{searchInput.value='';renderProducts();};

    // الطلبات
    function listenOrders(){
      onValue(ref(db,'orders'),snap=>{
        orders=snap.val()||{};
        renderOrders();
      });
    }
    
    function renderOrders(){
      ordersTableBody.innerHTML='';
      const filter = orderFilter.value;
      let list = Object.entries(orders);
      if (filter !== 'all') list = list.filter(([id,o]) => (o.status || 'pending') === filter);
      ordersCount.textContent = list.length;
      if (!list.length) { ordersEmpty.style.display = 'block'; return; }
      ordersEmpty.style.display = 'none';

      list.forEach(([id,o]) => {
        const total = Object.values(o.items || {}).reduce((s,it) => s + it.price * it.quantity, 0);
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${o.userEmail || '—'}</td>
          <td>${total} ريال</td>
          <td>${o.payment || 'غير محدد'}</td>
          <td><span class="status s-${o.status || 'pending'}">${o.status || 'pending'}</span></td>
          <td>${o.date ? new Date(o.date).toLocaleString() : '—'}</td>
          <td>
            ${Object.values(o.items || {}).map(it =>
              `${it.name} × ${it.quantity} — ${it.price} ريال`
            ).join('<br>')}
          </td>
          <td>${o.address || '—'}</td>
          <td class="actions">
            <button class="btn warn" data-confirm="${id}">تأكيد</button>
            <button class="btn" data-complete="${id}">إكمال</button>
            <button class="btn danger" data-cancel="${id}">إلغاء</button>
            <button class="btn ghost" data-delorder="${id}">حذف</button>
          </td>`;
        ordersTableBody.appendChild(row);
      });

      // إعادة ربط الأزرار بالأحداث
      ordersTableBody.querySelectorAll('[data-confirm]').forEach(b => b.onclick = () => setStatus(b.dataset.confirm,'confirmed'));
      ordersTableBody.querySelectorAll('[data-complete]').forEach(b => b.onclick = () => setStatus(b.dataset.complete,'completed'));
      ordersTableBody.querySelectorAll('[data-cancel]').forEach(b => b.onclick = () => setStatus(b.dataset.cancel,'cancelled'));
      ordersTableBody.querySelectorAll('[data-delorder]').forEach(b => b.onclick = () => deleteOrder(b.dataset.delorder));
    }

    orderFilter.onchange=renderOrders;

    // تنقل وخروج
    gotoShop.onclick=()=>window.location.href='buyer.html';
    logoutBtn.onclick=async()=>{await signOut(auth);localStorage.removeItem('loggedInUser');window.location.href='login.html';};

    function alertMsg(msg,err=false){ alertBox.textContent=msg; alertBox.className='alert '+(err?'error':'success'); alertBox.style.display='block'; setTimeout(()=>alertBox.style.display='none',2000); }
  
async function setStatus(id, status){
  await update(ref(db, 'orders/' + id), { status });
  alertMsg('تم تحديث حالة الطلب');
}

async function deleteOrder(id){
  if (!confirm('هل أنت متأكد من حذف الطلب؟')) return;
  await remove(ref(db, 'orders/' + id));
  alertMsg('تم حذف الطلب');
}

</script>
</body>
</html>

